---
title: "Comparing basic frequency-dependent models"
author: "Sarah P. Flanagan"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: yes
    number_sections: no
    template: manuscript.latex
    toc: yes
    toc_depth: 2
spacing: singlespacing
fontsize: 11pt
capsize: normalsize
documentclass: article
footerdate: yes
graphics: yes
csl: evolution.csl
editor_options:
  chunk_output_type: console
---

The purpose of this model is to understand how genetic architectures of alternative reproductive tactics impact their maintenance in populations. I'm using an individual-based simulation model with different selection scenarios, types of alternative tactics, and genetic architectures (genome-wide additive genetic variance, supergenes, expression networks). To explore the parameter space, I'm also using a mathematical model without the genetic architectures to identify regions of parameter space where we expect multiple morphs to be maintained. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,out.extra='',fig.pos="H",dpi=200,fig.height = 7,fig.width = 7)
knitr::opts_knit$set(root.dir='../results/') #change

```
```{r opts, echo = FALSE}
library(knitr)
knitr::opts_chunk$set(
  fig.path = "figs/"
)
```
```{r librarysetup, echo=FALSE,echo=FALSE,message=FALSE}
library(RColorBrewer)
library(scales)
library(sm)
library(kableExtra)
source("../R/002_freq_functions.R")

source("../morph_predictions/check_freqs.R")
source("../morph_predictions/morph_gens_ns.R")

cols<-c(courter="#33a02c",parent="#1f78b4",cpref="#b2df8a",ppref="#a6cee3")
cols2<-c(CP='#d7191c',NCP='#fdae61',CNP='#abd9e9',NCNP='#2c7bb6')
```
```{r baseCols}
base_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                   "FreqNcP","FreqCP","Courter2NonRS","Parent2NonSurvival")
poly_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                    "FreqNcP","FreqCP","Polygyny")

```


## Overview of the simulation model 

Males can be courters or not-courters and parents or not-parents. When the model is run with both traits, this results in four possible morphs: courter/parent, courter/not-parent, not-courter/parent, and not-courter/not-parent. Generations are non-overlapping and there is one reproductive bout per generation. In each generation, the population follows the following timeline: 

![Flowchart of simulation](../figs/simulation_flowchart_densitydependent.png)

Each step is explained in further detail below. 

\newpage

### 1. Choosing a nest

A female samples 50 males and chooses a male to nest with based on his courtship trait. If there are no courtship traits in the model, she chooses based on the male's parental trait. If she does not encounter an acceptable male, she nests with a randomly chosen male. If she encounters multiple equally-acceptable males, she either randomly selects a male from the population or does not mate, depending on the chosen parameter settings.  

### 2. Fertilization

Once a female decides to nest, up to three males can fertilize the nest. Courting males contribute a different amount of sperm than non-courting. The male with whom the female is nesting gets $r_{courter}/\Sigma{n_{sperm}}$ and additional non-courting males (up to 2) get $(r_{non-courter}*0.5/\Sigma{n_{sperm}})$, where $\Sigma{n_{sperm}}$ is the total number of sperm contributed by all of the males, weighted by the sperm competition factor (0.5 is the default for all males except the chosen male). So, when a female mates with one courter and two non-courters, $\Sigma{n_{sperm}}$ = $r_{courter}$ + 2$*$(0.5$*$$r_{non-courter}$). In these runs, males who are courters cannot sneak fertilizations. Every time a male mates he uses his sperm, so if after one mating a male fertilizes 2 eggs, he only has $n_{sperm}-2$ sperm for his next mating. 


### 3. Nest Survival

Before the offspring can survive, the nest has to survive. This step is only relevant when parental traits are in the model - if only the courtship trait is specified, then all progeny in the nest survive at this point. When males have the parental trait, if the female has given eggs to a non-parental male (because she chose based on courtship traits), then the nest has a 0% chance of surviving. If the female has given eggs to a parental male, the nest has a 100% chance of surviving. 

### 4. Density-dependent survival

Once the identities of the surviving nests are known--along with the identities of the parents, including sneaker parents--the offspring are created in the simulation. The offspring are created to fill the full carrying capacity of the population, with the numbers per nest being equally divided among all surviving offspring. This allows the population to maintain a constant population size (prior to viability selection) while maintaining the relative successes of the given genotypes/morphs. 

### 5. Viability selection 

Before becoming adults, the offspring experience viability selection. Courters and parental males are disfavored in viability selection, with a survival probability of `r exp(-0.5/(2*50))`. If an individual is both a courter and a parental male, the survival probability is `r exp(-1/(2*50))*exp(-1/(2*50))`. Non-courters and non-parental males have survival probabilities of 1. 

### Evaluating equilibrium

After 10000 generations, I begin tracking the change in frequency of the courter and parent traits, and do so for 2000 additional generations. I calculate the variance in the change in frequency over those 2000 generations. I declare an equilibrium ('stasis') has been reached if the last change in frequency of both traits is less than the variance in changes in frequency. 

### Replicates

Using the parameter settings described below, I ran five independent instances of the model, each of which had four replicates spawned from identical starting conditions. This approach was chosen to reduce the effects of stochasticity in this type of model. In the multi-panel figures from the simulation model, each row contains the four replicates that originated with identical starting conditions. 


\newpage{}

## Overview of the mathematical model 

The mathematical model was designed with the same population of courters and non-courters and parents and non-parents in mind. In this version, I track the number of offspring produced at each step. 


![Flowchart of mathematical model](../figs/mathModel_Ns_diagram.png)


## 1. Establishing nests

The number of nests that can be created in the population is determined by the number of males that will be chosen by females. This is determined by the $w_s$ parameter, which in currrent settings is 1 for courters and 0 for non-courters. Each morph has a total reproductive effort (total number of sperm from that morph), $s_M$, which is the individual reproductive effort $r_M$ multiplied by the number of males of each morph. 

## 2. Fertilization

In the fertilization step, there are two components: the eggs males fertilize in their own nests ($e_o$) and the egg fertilized in other males' nests through sneaking ($e_s$. Only courters are chosen by females, so only courters fertilize their own eggs (this is controlled by the ${w_s}_M$ term, which is 1 for courters and 0 for non-courters). 

The number of eggs fertilized by non-courters is dependent on the availability of nests. For that reason, the number of eggs fertilized in others' nests is either the difference between the maximum number of offspring that can be produced by non-courters ($N_s$). This value is determined by the reproductive effort of non-courters (represented by $r_{NN}$), the total number of nests ($n$), and the number of sneakers per female ($num_{sneakers}$) weighted by the sperm competition coefficient ($c$).

## 3. Nest survival

Nests survive based on whether the male is a parent (it survives) or a non-parent (it does not survive). 

## 4. Offspring survival

Offspring who are in surviving nests are subjected to (relatively weak) viability selection against the courter and parent traits. This selection is multiplicative for courter-parents. 

## 5. Equilibrial results

The next generation's frequencies are determined by 


### Frequency-dependent expectations


$r_{courter}=4$ and $r_{non-courter}=8$. , where $r_{courter}$ = 8 and $r_{non-courter}$ = 4, therefore $\Sigma{n_{sperm}}$ = `r sum(8,rep((0.5*4),2))`. 

I used the frequency-dependent mathematical model to identify parameter space when diversity is maintained and when it is expected to be lost. I then ran the single-locus model (essentially, adding stochasticity) to see if I am reproducing those expectations using the simulation model.

```{r highDiv}
highDiv<-get.morph.freqs(plot.pc.reps(pattern="highDiversity.*summary.txt",path="single_locus",cols,make.plot=FALSE))
```
```{r highDivPlot, fig.cap="Final generation frequencies based on the single locus model with parameters that are expected to result in diversity, based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available). Those labelled with 'RM' were runs where females mated at random. Runs labelled 'v0' did not impose viability selection on males."}
var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",rownames(highDiv)))

par(mfrow=c(2,length(var_patts)/2),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-highDiv[grep(paste0(pattern,"_\\d"),rownames(highDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=pattern)
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```


```{r lowDiv, fig.cap="Final generation frequencies based on the single locus model with parameters that are expected to result in no diversity, based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available). Those labelled with 'RM' were runs where females mated at random. Runs labelled 'v0' did not impose viability selection on males."}
lowDiv<-get.morph.freqs(plot.pc.reps(pattern="lowDiversity.*summary.txt",path="single_locus",cols,make.plot=FALSE))
```
```{r lowDivPlot}
var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",rownames(lowDiv)))

par(mfrow=c(2,length(var_patts)/2),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=pattern)
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```


### Initial parameter combinations 

I first started off with my defaults for the model, which is when courters and parents have a reproductive advantage (they can fertilize 8 eggs compared to the non-courter and non-parent's 4 eggs). The nesting male (regardless of phenotype) experienced a reproductive advantage by fertilizing a higher proportion of the eggs. Furthermore, females always prefer courters to non-courters and only nest with non-courters when they cannot find a courter in the males they evaluate. I therefore expected that the courter/parent morph would dominate and no variation would be maintained.

```{r courterRS, fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=3,fig.width=6.5, eval=FALSE}
courterRS<-get.morph.freqs(plot.pc.reps(pattern="pcu_1locus_nestBinary_courterRSadvantage.*summary.txt",path="single_locus",cols,make.plot=FALSE))
courterRS$Courter2NonRS<-8/4
bp<-barplot(t(as.matrix(courterRS[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg = gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,
        border=NA)
text(x=bp,y=0.5,srt=90,labels = courterRS$FreqCP)
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```


With the current set of conditions, when males are only permitted to mate once, the non-courter/parent morph is the only one maintained in the population (Fig. \@ref(fig:courterRS)), which is counter to our prediction. However, it does follow our prediction that only parents will be able to be maintained in the population. 

On the other hand, when males are allowed to mate multiply, the courter/parent morph dominates the population but is not always the only morph present (Fig. \@ref(fig:polyCourterRS)).

```{r polyCourterRS, fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=3,fig.width=6.5, eval=FALSE}
courterRSpoly<-get.morph.freqs(plot.pc.reps(pattern="pcu_1locus_polygyny_nestBinary_courterRSadvantage.*summary.txt",path="single_locus",cols,make.plot=FALSE))
courterRSpoly$Courter2NonRS<-8/4
bp<-barplot(t(as.matrix(courterRSpoly[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRSpoly)),
        las=2,
        border=NA)
text(x=bp,y=0.5,srt=90,labels = courterRSpoly$FreqCP)

par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```


I ran a set of models with the following parameter variations, with my naiive expectation (prior to the numerical analysis) for whether variation should be maintained or not.

```{r}
expTab<-data.frame(Name=c("courterRSadvantage", "equalFitness","onlySpermComp","sneakRSadvantage","sneakRSadvantage_courterRSadvantage"),
                   ParentRS=c(8,4,4,4,4),
                   NonParentRS=c(4,4,4,8,8),
                   CourterRS=c(8,4,4,4,8),
                   NonCourterRS=c(4,4,4,4,4),
                   SpermCompFactor=c(0.5,1,0.5,0.5,0.5),
                   MultipleMorphs=c("No","Yes","Yes","Yes","Yes"))
kable(expTab,booktabs=TRUE,"latex",
      caption = "The different parameter settings used for the models and whether I expected multiple morphs to be maintaned.") %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```


```{r multipleMorphs,fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The top row are runs where males can only mate once and the bottom row are runs where males can mate with multiple females. The top row is for the case when males mate with one female, and the bottom is polygyny. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=6,fig.width=8, eval=FALSE}
var_patts<-c("pcu_1locus_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt")

par(mfrow=c(2,length(var_patts)/2),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-get.morph.freqs(plot.pc.reps(pattern=pattern,path="single_locus",cols,make.plot=FALSE))
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("^.*nestBinary_(\\w+)[[:punct:]].*","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```

These runs did not produce as much variation as I expected, and raised several questions:

1. What allows non-courter/parents to dominate in some cases, when they shouldn't be chosen as nesting mates by females?

2. What causes one or another sneaker morph to become present in the population?

3. What causes the variation among runs in terms of the outcomes?

The answers to these three questions are likely to be somewhat linked. 

## Addressing raised questions

First, I tried to understand what was allowing the non-courter/parents to dominate the monogamy models. In the model, females sample 50 males in the population and if they do not find a courter male, they will then mate randomly. This random mating is the only pathway through with non-courter/parent males should be able to mate, because only non-parents are sneakers. To ensure that this is the case, I ran the model turning off the random-mating option, so females do not successfully mate if they cannot find a courter male. In these runs we would expect the dominant morph in the population to be a courter/parent, which we see is the case (Fig. \@ref(fig:multipleMorphsNM)). This figure can be compared to Fig. (\@ref(fig:multipleMorphs)), and in doing so we see that under monogamous conditions the Non-Courter/Parent morph is displaced as the dominant one by the Courter/Parent morph. The polygynous cases are similar to the cases when females can mate randomly if they do not encounter an attractive male.  

```{r multipleMorphsNM,fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. The top row are runs where males can only mate once and the bottom row are runs where males can mate with multiple females. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=6,fig.width=8, eval=FALSE}
nm_patts<-c("pcu_1locus_nestBinary_nm_courterRSadvantage.*summary.txt",
             "pcu_1locus_nestBinary_nm_equalFitness.*summary.txt",
             "pcu_1locus_nestBinary_nm_onlySpermComp.*summary.txt",
             "pcu_1locus_nestBinary_nm_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_nestBinary_nm_sneakRSadvantage_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt")
par(mfrow=c(2,length(nm_patts)/2),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
nmDat<-lapply(nm_patts,function(pattern){
  dat<-get.morph.freqs(plot.pc.reps(pattern=pattern,path="single_locus",cols,make.plot=FALSE))
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("^.*nestBinary_(\\w+)[[:punct:]].*","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```

The monogamous result suggests that the number of mates a female can search is an important parameter in the model. I would expect that in the non-random mating scenario, the population would crash if I hadn't adjusted the model so that each generation is created in numbers proportional to the produced offspring to maintain a stable population size.

Next, I dug into the results to look into the relationship with initial frequencies to see how important those stochasitic differences in morph frequencies are in the outcomes. I somewhat expected that the initial frequencies might drive which morphs were found in the final runs. Fig. (\@ref(fig:FinalMorphsInitialTraitsThresh)) suggests that the initial conditions do differ, and therefore *could* play a role, but consistent patterns don't emerge. Therefore, I wanted to investigate the role of some of my other assumptions in the model. 


```{r, eval=FALSE}
eqFitness<-plot.pc.reps(pattern="pcu_1locus_polygyny_nm_nestBinary_equalFitness.*summary.txt",path="single_locus",cols,make.plot=FALSE)
courterRS1<-get.morph.freqs(eqFitness,gen="first")
courterRS<-get.morph.freqs(eqFitness)
```

```{r FinalMorphsInitialTraitsThresh,fig.cap="Final frequencies of alternative morphs (not parent-courter) and initial trait and morph frequencies for 'equalFitness' runs, polygynyous mating was allowed, but females were not allowed to mate randomly if they did not find an acceptable male. The top row show the alternative morph frequencies in the final generation, without the courter-parent morph (which was dominant). The middle row shows the deviations from 0.5 for the courter and parent morphs in the initial generation of the model. The bottom row shows the threshold values (which are the mean parent and courter trait values in the initial generation) for determining whether an individual is a courter or a parent. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from.", eval=FALSE}
par(mfrow=c(3,1))
bp<-barplot(t(as.matrix(courterRS[,c("FreqNcNp", "FreqCNp", "FreqNcP")])),
        col=cols2[c("NCNP","CNP","NCP")],
        names.arg = gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,
        border=NA)
legend(x=3,y=0.05,bty='n',legend = c("Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=3,cex=1.25)
mtext("Final Morph Frequencies",2,line=2.2,cex=0.8)
bp<-barplot(t(as.matrix(courterRS1[,c("CourterFreq", "ParentFreq")]))-0.5,
        col=cols[c("courter","parent")],
        names.arg = gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,beside = TRUE,
        border=NA)
legend(y=.05,x=15,xpd=TRUE,c("courter","parent"),col=cols[c("courter","parent")],
       ncol=2,pch=15,bty='n',cex=1.25)
mtext("Initial Trait Frequencies",2,line=2.2,cex=0.8)
bp<-barplot(t(as.matrix(courterRS1[,c("CourterThresh", "ParentThresh")])),
        col=cols[c("courter","parent")],
        names.arg = gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,beside = TRUE,
        border=NA)
legend(y=1.5,x=15,xpd=TRUE,c("courter","parent"),col=cols[c("courter","parent")],
       ncol=2,pch=15,bty='n',cex=1.25)
mtext("Initial Trait Thresholds",2,line=2.2,cex=0.8)
```

Looking at the time-series of the frequencies of the morphs for one of the combinations that results in variation (polgyny, equal fitness, without allowing for random mating) -- which have variation showing up in a number of runs (Fig. \@ref(fig:eqFitness)) -- we see that the courter/parent morph rises to nearly a frequency of 1 within very few generations (Fig. \@ref(fig:timeSeriesFreqs)), but in some cases doesn't actually become fixed. If we focus only on the early generations (for instance, the first 50), we can see that in the runs that maintain small amounts of variation at the end, at least one of the morphs, but not necessarily the one that survives til the end, has a gradual rather than a sharp decline (Fig. \@ref(fig:timeSeriesFreqs50)). 

```{r eqFitness, fig.cap="A close-up view of the equal fitness pane from above, showing the final frequencies of the four morphs for the polygyny, equal fitness, no random mating runs of the model.",fig.height=3,fig.width=6.5, eval=FALSE}
courterRSpoly<-get.morph.freqs(eqFitness)
bp<-barplot(t(as.matrix(courterRSpoly[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,
        border=NA)
text(x=bp,y=0.5,srt=90,labels = courterRSpoly$FreqCP)

par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```



```{r timeSeriesFreqs, fig.cap="Time series of frequencies of all four morphs across all 12000 generations of the model when run with polygyny, the equal fitness parameters from the table, and without allowing females to mate randomly if they fail to find a courter male. All four morphs start around 0.25 and the courter/parent rapidly rises towards fixation. Each row is one set of replicates that all shared the same initial starting conditions.", eval=FALSE}
plot.morphs.reps(eqFitness,
                 cols2,
                 ncols = 4)

```

```{r timeSeriesFreqs50,fig.cap="Time series of frequencies of all four morphs across all 12000 generations of the model when run with polygyny, the equal fitness parameters from the table, and without allowing females to mate randomly if they fail to find a courter male. All four morphs start around 0.25 and the courter/parent rapidly rises towards fixation. Each row is one set of replicates that all shared the same initial starting conditions.", eval=FALSE}
plot.morphs.reps(eqFitness,
                 cols2,
                 ncols=4,
                 xlim=c(0,50))

```


If we narrow our attention to the final generations and the very small frequencies to focus in on the alternate morphs towards the end, it's clear that in some of these cases the different alternative morphs are trading off which one is persisting in the population (Fig. \@ref(fig:timeSeriesFreqsYlim)).

```{r timeSeriesFreqsYlim,fig.cap="Time series of frequencies of all four morphs across all 12000 generations of the model when run with polygyny, the equal fitness parameters from the table, and without allowing females to mate randomly if they fail to find a courter male. All four morphs start around 0.25 and the courter/parent rapidly rises towards fixation. Each row is one set of replicates that all shared the same initial starting conditions.", eval=FALSE}
plot.morphs.reps(eqFitness,
                 cols2,
                 ncols=4,
                 xlim=c(11990,1200),
                 ylim=c(0,0.1))

```

\newpage{}

While these investigations help understand some of what's driving the model, it's still unclear:

- what mechansims cause a gradual vs sharp decline in initial frequency

- what drives one alternative to persist rather than another

- why only one or two individuals can survive as alternative morphs


## Without viability selection

As Suzanne expected, if we have no viability selection, the courter/parent morph becomes fixed in the population.


```{r multipleMorphsNoViability,fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The top row are runs where males can only mate once and the bottom row are runs where males can mate with multiple females. The top row is for the case when males mate with one female, and the bottom is polygyny. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=6,fig.width=8, eval=FALSE}
var_patts<-c("pcu_1locus_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt")

par(mfrow=c(2,length(var_patts)/2),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-get.morph.freqs(plot.pc.reps(pattern=pattern,path="single_locus/no_viability",cols,make.plot=FALSE))
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("^.*nestBinary_(\\w+)[[:punct:]].*","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```
