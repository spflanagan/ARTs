---
title: "ARTs notebook"
output: html_notebook
author: "Sarah P. Flanagan"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,out.extra='',fig.pos="H",dpi=200,fig.height = 7,fig.width = 7)
knitr::opts_knit$set(root.dir='../fixedART-results/') #change
source("~/Research/ARTs/R/002_freq_functions.R")
```

# 14 October 2020

So I've neglected this analysis for a very long time, and now I'm not quite sure where I am. I downloaded a bunch of files from the supercomputer earlier this year, all of which were reproductive allocation ones. I saved these in oct2019/ to avoid overwriting any in repro_allocation, so they all finished properly. I moved the ones that didn't overwrite using `mv -n`. The ones that would have overwritten the ones in repro_allocation remain in oct2019. All of the files in repro_allocation are 'complete'.

So now I'm re-knitting the doc to evaluate where I'm at. 

The plotting is really  not helpful. I need to change this!

I've turned the summary plots into stacked barplots, which is better for comparing frequencies. 

what do I want to show in the summary doc?
* how do I show the role of mating system?
* do I care about the thresholds?
* are there other runs I should summarize?

I also need to ID next steps, which include at least popgen analyses.


# 2 September 2019

The simulations finished running, so now I'm going to re-evaluate the analysis by looking at the final generations like below.

```{r}
cps_ra<-plot.pc.reps(pattern="^parent-courter_.*_RA_.*_summary.txt",path="repro_allocation",cols="red",make.plot=FALSE)
max_gens<-unlist(lapply(cps_ra,function(dat) return(max(dat$Generation))))
max_gens<-max_gens[max_gens!="-Inf"]
good_files<-unique(gsub("_\\d$","",names(max_gens[max_gens==11999])))
bad_files<-unique(gsub("_\\d$","",names(max_gens[max_gens<11999])))
```

This fixed it, there are 0 bad files! Woo hoo! Now to recompile the document to learn something about the model results.

I'm also putting the 'reproductive allocation' data in the directory repro_allocation/ within fixedARTs-results/.

I need to run more simulations to fill in the patterns (not to mention come up with better ways to present the analyses, hopefully). Started runs with more combos on abacus, job array is 1385398.1-3.

# 19 August 2019

Ok I've put off dealing with this for a while. I've re-created the good_files and bad_files as below and will do a couple things. 
1. Check if it says "Evaluating equilibirum" in the log file. 
   nope
2. Check if it says "Input integer to quit" in the log file. 
  nope
3. Other error messages?

Ok, wait, one of the 'bad_files' actually ran through to equilibrium according to the log file:
parent-courter_supergene_RA_c2_nc2_p0.2_np0.6_1.log shows 11999 generations, but
parent-courter_supergene_RA_c2_nc2_p0.2_np0.6_1_summary.txt.gz only goes to 3899 generations. what?

Let's check the outputting functions in my code (I don't know what would have happened).

I've fixed some of the extinction checking but I don't think this is what's causing the issue. 

The only thing that seems like it could be the explanation would be a space issue? Maybe I run out of space on the supercomputer? Then I would expect the later-in-the-loop parameters to be bad. 

Ok, so first I need to figure out why I'm getting -Inf values in my max_gens. This seems to be due to sensitivity/parent-courter_supergene_RA_c8_nc4_p0.4_np0.6_1_summary.txt.gz_1, which has no rows for Pop 1...it seems the numbering got shifted somehow. Weird. I'll just ignore it then.  

```{r}
cps_ra<-plot.pc.reps(pattern="^parent-courter_.*_RA_.*_summary.txt",path="sensitivity",cols,make.plot=FALSE)
max_gens<-unlist(lapply(cps_ra,function(dat) return(max(dat$Generation))))
max_gens<-max_gens[max_gens!="-Inf"]
good_files<-unique(gsub("_\\d$","",names(max_gens[max_gens==11999])))
bad_files<-unique(gsub("_\\d$","",names(max_gens[max_gens<11999])))

```

```{r}
bad_chars<-data.frame(arch=gsub("sensitivity/parent-courter_(\\w+)_RA.*","\\1",bad_files),
                      cval=gsub(".*_RA_c(.*)_nc.*_p.*_np.*_.*","\\1",bad_files),
                      ncval=gsub(".*_RA_c.*_nc(.*)_p.*_np.*_.*","\\1",bad_files),
                      pval=gsub(".*_RA_c.*_nc.*_p(.*)_np.*_.*","\\1",bad_files),
                      npval=gsub(".*_RA_c.*_nc.*_p.*_np(.*)_\\d+.*","\\1",bad_files),
                      rep=gsub(".*_RA_c.*_nc.*_p.*_np.*_(\\d+).*","\\1",bad_files))

good_chars<-data.frame(arch=gsub("sensitivity/parent-courter_(\\w+)_RA.*","\\1",good_files[grep("RA",good_files)]),
                      cval=gsub(".*_RA_c(.*)_nc.*_p.*_np.*_.*","\\1",good_files[grep("RA",good_files)]),
                      ncval=gsub(".*_RA_c.*_nc(.*)_p.*_np.*_.*","\\1",good_files[grep("RA",good_files)]),
                      pval=gsub(".*_RA_c.*_nc.*_p(.*)_np.*_.*","\\1",good_files[grep("RA",good_files)]),
                      npval=gsub(".*_RA_c.*_nc.*_p.*_np(.*)_\\d+.*","\\1",good_files[grep("RA",good_files)]),
                      rep=gsub(".*_RA_c.*_nc.*_p.*_np.*_(\\d+).*","\\1",good_files[grep("RA",good_files)]))
```

All of these seem the same. So what if the errors about gzip errors are giving me the real information? Nope, that doesn't seem to be an indicator.

Is this happening for the non-supergene ones?

The question in my mind is whether this is a bug or a supercomputer glitch. It seems too frequent to be a supercomputer glitch, but I also cannot figure out what went wrong. 

In the command line, I did `zgrep "11999.*Pop3" *summary.txt.gz > popsizeSearch.txt` and `zgrep "equilibrium" *log > equilibriumSearch.txt` 

```{r}
eq<-read.delim("sensitivity/equilibriumSearch.txt",header = FALSE)
eq$name<-gsub("(.*).log:.*","\\1",eq$V1)
ps<-read.delim("sensitivity/popsizeSearch.txt",header=FALSE)
ps$name<-gsub("(.*)_summary.txt.gz:.*","\\1",ps$V1)
```

The popsize search ones should be the same as the good_files, I expect

```{r}
which(!paste0("sensitivity/",ps$name,"_summary.txt.gz") %in% good_files)
```


....I wonder if it's gzipping ones that are being run?? That's probably it! If I have the gzip in the same script then it needs to be more specific and only gzip the ones it just did. Hopefully this resolves the issue. I'm running it again on the supercomputer to see.

# 22 July 2019

The test run ran without any problems -- all the way through to generation 11999. This does not help me solve the issue. 

# 19 July 2019

Looking at the C++ code, the summary data is output for all initial generations and experimental generations. The only way the number of generations is cut short is through extinction. Equilibrium is only evaluated after all experimental generations. So the only thing I can think of is that this is an issue with running it on the server?? This is a major issue because it's I'm looking at the frequencies in the FINAL generation, and if I'm only seeing intermediate generations then I'm not necessarily seeing the right stuff. Let's take a look at the data again:

```{r setup, echo=FALSE,echo=FALSE,message=FALSE}
library(RColorBrewer)
library(scales)
library(sm)
library(kableExtra)
source("~/Research/ARTs/R/002_freq_functions.R")
cols<-c(courter="#33a02c",parent="#1f78b4",cpref="#b2df8a",ppref="#a6cee3")
cols2<-c(CP='#a1dab4',NCP='#41b6c4',CNP='#2c7fb8',NCNP='#253494')
base_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                   "FreqNcP","FreqCP","Courter2NonRS","Parent2NonSurvival")
```

```{r lookingAtGens}
cps_baseline<-plot.pc.reps("^parent-courter_supergene_.*_summary.txt",path="baseline",cols,make.plot=FALSE)
cps_ra<-plot.pc.reps(pattern="^parent-courter_supergene_RA_.*_summary.txt",path="sensitivity",cols,make.plot=FALSE)
max_gens<-c(unlist(lapply(cps_baseline,function(dat) return(max(dat$Generation)))),
            unlist(lapply(cps_ra,function(dat) return(max(dat$Generation)))))
hist(max_gens)  
```

`r length(max_gens[max_gens<11999])` of `r length(max_gens)` runs have fewer than the expected number of generations. Running `grep "crashed" parent-courter_supergene_RA*log` results in no output. 

The only error messages in the server log files are gzip errors (I'm guessing it tried to run gzip on files that had already been gzipped?). But those were all run starting May 27 or 28...so maybe there's an informative batch effect I can deduce?

```{r}
good_files<-unique(gsub("_\\d$","",names(max_gens[max_gens==11999])))
bad_files<-unique(gsub("_\\d$","",names(max_gens[max_gens<11999])))
file.info(good_files)$mtime
file.info(bad_files)$mtime
```

Ok, so there doesn't seem to be a pattern with when they were created. 

Are the only ones with variation the ones that have finished early?

```{r}
cps_ra_freqs<-get.morph.freqs(cps_ra)
cps_ra_freqs$Parent2NonSurvival<-as.numeric(gsub(".*_p(\\d.\\d).*","\\1",rownames(cps_ra_freqs)))/as.numeric(gsub(".*np(\\d.\\d).*","\\1",rownames(cps_ra_freqs)))
cps_ra_freqs$Courter2NonRS<-as.numeric(gsub(".*_c(\\d).*","\\1",rownames(cps_ra_freqs)))/as.numeric(gsub(".*nc(\\d).*","\\1",rownames(cps_ra_freqs)))

plot_2vars_summary(cps_ra_freqs[cps_ra_freqs$Generation==11999,],"Courter2NonRS","Parent2NonSurvival",mar=c(5.1,4.1,4.1,2.1))

```

Ok, so some variation does still happen. Are there any other indications? Perhaps the parameter values?

```{r}
plot_2vars_summary(cps_ra_freqs[cps_ra_freqs$Generation<11999,],"Courter2NonRS","Parent2NonSurvival",mar=c(5.1,4.1,4.1,2.1)) #this doesn't help
# extract all parameter info
cps_ra_freqs$C<-as.numeric(gsub(".*RA_c(\\d)_.*","\\1",rownames(cps_ra_freqs)))
cps_ra_freqs$NC<-as.numeric(gsub(".*_nc(\\d)_.*","\\1",rownames(cps_ra_freqs)))
cps_ra_freqs$P<-as.numeric(gsub(".*_p(\\d.\\d)_.*","\\1",rownames(cps_ra_freqs)))
cps_ra_freqs$NP<-as.numeric(gsub(".*_np(\\d.\\d)_.*","\\1",rownames(cps_ra_freqs)))
cps_ra_freqs$rep<-as.numeric(gsub(".*_(\\d)_summary.*","\\1",rownames(cps_ra_freqs)))
cps_ra_freqs$Problem<-FALSE
cps_ra_freqs$Problem[cps_ra_freqs$Generation<11999]<-TRUE

tapply(cps_ra_freqs$rep,cps_ra_freqs$Problem,summary)
tapply(cps_ra_freqs$C,cps_ra_freqs$Problem,summary)
tapply(cps_ra_freqs$NC,cps_ra_freqs$Problem,summary)
tapply(cps_ra_freqs$P,cps_ra_freqs$Problem,summary)
tapply(cps_ra_freqs$NP,cps_ra_freqs$Problem,summary)

```

None of these seem to factor into whether it's a problem child or not. What else could it be??? Stochasticity? Time of day?

```{r}
file.info(good_files)$mtime
file.info(bad_files)$mtime
```

Well, these are the times when they were downloaded, not the times they were run, and I've already deleted the files off the server. I have no idea what could be causing this issue!!

I'm going to try running one of the bad combos on my local computer, and next time I should check to see if the same thing is happening with the other genetic architectures.


# 18 July 2019

I'm transitioning from my paper notebook to this online notebook to improve reproducibility and better track my work and progress.

So far with the ARTs model I've been testing how sensitive it is to reproductive parameters -- the relative reproductive allocation for courters vs noncourters and the nest survival rates for parents vs nonparents. 

![results for QTLs in a supergene]("../figs/unnamed-chunk-11-1.png")

Looking at these results, a few things stand out to me:

* The points at different frequencies are hard to see
* The diamonds and triangles seem to be different sizes, which throws off some amount of inference
* There don't seem to be overly consistent patterns! 
* I've apparently kept my runs to a particular part of parameter space
* I should label my chunks in the Rmd so that the figures get useful names

I recently added the output of allelic effects to my code, hoping that doing so might shed some light on what determines the outcome of each run, because as I noted on 7 May 2019, the thresholds alone are not useful. So FIRST I'm going to dive into the allelic effects, focusing on those results for QTLs in a supergene. Taking the code to load and create that figure from 105_sensitivity-analysis-summary.Rmd:

First we'll read in the data from the relevant runs -- focusing only on the QTLs + supergenes that are newest, so those labelled with "RA" (plus the baseline):

```{r RA_basecols}
base_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                   "FreqNcP","FreqCP","Courter2NonRS","Parent2NonSurvival")
```
```{r setup, echo=FALSE,echo=FALSE,message=FALSE}
library(RColorBrewer)
library(scales)
library(sm)
library(kableExtra)
source("~/Research/ARTs/R/002_freq_functions.R")
cols<-c(courter="#33a02c",parent="#1f78b4",cpref="#b2df8a",ppref="#a6cee3")
cols2<-c(CP='#a1dab4',NCP='#41b6c4',CNP='#2c7fb8',NCNP='#253494')
```

```{r readBaseline_Supergene}
cps_baseline_freqs<-get.morph.freqs(plot.pc.reps("^parent-courter_supergene_.*_summary.txt",path="baseline",cols,make.plot=FALSE))
cps_baseline_freqs$Courter2NonRS<-8/4
cps_baseline_freqs$Parent2NonSurvival<-0.9/0.1
```

```{r readNonParentalRA_Supergene}
cps_ra_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_supergene_RA_.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cps_ra_freqs$Parent2NonSurvival<-as.numeric(gsub(".*_p(\\d.\\d).*","\\1",rownames(cps_ra_freqs)))/as.numeric(gsub(".*np(\\d.\\d).*","\\1",rownames(cps_ra_freqs)))
cps_ra_freqs$Courter2NonRS<-as.numeric(gsub(".*_c(\\d).*","\\1",rownames(cps_ra_freqs)))/as.numeric(gsub(".*nc(\\d).*","\\1",rownames(cps_ra_freqs)))
#MODIFIED FROM SOURCE SCRIPT BECAUSE I'M NOT USING THE OTHER RUNS
cps_all_freqs<-rbind(cps_ra_freqs[,base_keep_cols],cps_baseline_freqs[,base_keep_cols])
```


Now we can make a summary plot!

```{r RA_Summary}
plot_2vars_summary(cps_all_freqs,"Courter2NonRS","Parent2NonSurvival",mar=c(5.1,4.1,4.1,2.1))
```

So an interesting run seems to be when the reproductive allocation is 2 courter : 1 non-courter and 0.67 parent : non-parent

```{r exploreRA}
cps_all_freqs[cps_all_freqs$Courter2NonRS==2 & round(cps_all_freqs$Parent2NonSurvival,2)==0.67,]
```

This set of parameters contains one run that apparently didn't go well, `r rownames(cps_all_freqs[is.na(cps_all_freqs$PopSize),])`. Intriguingly, it's just that first population and not the other populations. It looks like that is the only population that could not reach an equilibrium -- it only had a population size of 991 as well. So I need to update the code to include in the summary non-equilibrium pops as well, perhaps...or this is the better choice? Do I actually not output the information or is it simply not read by the summary functions? Either way, this is what the 'true' graph should look like:

```{r RA_SummaryNArm}
plot_2vars_summary(cps_all_freqs[!is.na(cps_all_freqs$PopSize),],"Courter2NonRS","Parent2NonSurvival",mar=c(5.1,4.1,4.1,2.1))
```

Before moving forward, I'd like to investigate this non-equilibrium issue, so let's read in that summary file.

```{r RAc8nc5p4np6, warning=FALSE}
dat<-read.delim(gzfile(gsub("_1$","",rownames(cps_all_freqs[is.na(cps_all_freqs$PopSize),]))),header = TRUE,sep='\t')
nrow(dat[dat$Pop=="Pop0",])
nrow(dat[dat$Pop=="Pop1",])
tapply(dat$Generation,dat$Pop,max)
```


Ok, so that's weird. Obviously there's a bug in the code where the population data doesn't get output -- maybe for Pop 3 when it's reached equilibrium? Also, I feel I should keep running it until equilibrium is reached for each population. Looking at the C++ code doesn't reveal anything immediately obvious, so let's take a look at the rows around this error.

```{r}
weirdn<-which(!dat$Pop %in% c("Pop0","Pop1","Pop2","Pop3"))
dat[(weirdn-5):(weirdn+5),]
```

What happened at generations 1956 - 1963?? This is really strange because it should have been during the initial generations (10000, checked using `zless parent-courter_supergene_RA_c8_nc4_p0.4_np0.6_1_parameters.txt.gz`), unless I'm mis-labelling the experimental ones. Let's look at the distribution of generations

```{r}
hist(dat$Generation,seq(0,6500,1))
```

The giant black block suggests that they're all respresented the same number of times, which means that this particular run stopped within the initial generations, which shouldn't happen. 

Let me see what one that behaves 'normally' looks like:

```{r}
testdat<-read.delim(gzfile(gsub("_\\d$","",rownames(cps_all_freqs[which(is.na(cps_all_freqs$PopSize))+5,]))),header = TRUE,sep='\t')
tapply(testdat$Generation,testdat$Pop,max)
```

Ok, so this one doesn't have weird entries but it does seem to have stopped during the initial generations, unless I'm misunderstanding my output. The log file also tracks it as going to generation 11999, but it's not in the summary output -- equilibrium is reached, perhaps that's the issue? I'm thinking I need to revisit my program before moving forward, because this is an important component of how I'm evaluating this output.

