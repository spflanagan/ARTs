---
title: "Single locus models"
author: "Sarah P. Flanagan"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: yes
    number_sections: no
    template: manuscript.latex
    toc: yes
    toc_depth: 2
spacing: singlespacing
fontsize: 11pt
capsize: normalsize
documentclass: article
footerdate: yes
graphics: yes
csl: evolution.csl
editor_options:
  chunk_output_type: console
---

The purpose of this model is to understand how genetic architectures of alternative reproductive tactics impact their maintenance in populations. I'm using an individual-based simulation model with different selection scenarios, types of alternative tactics, and genetic architectures (genome-wide additive genetic variance, supergenes, expression networks).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,out.extra='',fig.pos="H",dpi=200,fig.height = 7,fig.width = 7)
knitr::opts_knit$set(root.dir='../results/') #change

```
```{r opts, echo = FALSE}
library(knitr)
knitr::opts_chunk$set(
  fig.path = "figs/"
)
```
```{r librarysetup, echo=FALSE,echo=FALSE,message=FALSE}
library(RColorBrewer)
library(scales)
library(sm)
library(kableExtra)
source("~/Dropbox (UC Enterprise)/Research/ARTs/R/002_freq_functions.R")
cols<-c(courter="#33a02c",parent="#1f78b4",cpref="#b2df8a",ppref="#a6cee3")
cols2<-c(CP='#d7191c',NCP='#fdae61',CNP='#abd9e9',NCNP='#2c7bb6')
```
```{r baseCols}
base_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                   "FreqNcP","FreqCP","Courter2NonRS","Parent2NonSurvival")
poly_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                    "FreqNcP","FreqCP","Polygyny")

```


## Overview of the model 

Males can be courters or not-courters and parents or not-parents. When the model is run with both traits, this results in four possible morphs: courter/parent, courter/not-parent, not-courter/parent, and not-courter/not-parent. Generations are non-overlapping and there is one reproductive bout per generation. In each generation, the population follows the following timeline: 

![Flowchart of simulation](../figs/density-dependent-flowchart.jpg)

Each step is explained in further detail below. 

\newpage

### 1. Choosing a nest

A female samples 50 males and chooses a male to nest with based on his courtship trait. If there are no courtship traits in the model, she chooses based on the male's parental trait. If she does not encouter an acceptable male, she nests with a randomly chosen male. If she encounters multiple equally-acceptable males, she randomly selects one of them.  

### 2. Fertilization

Once a female decides to nest, up to three males can fertilize the nest. Courters and parental males can contribute more sperm than non-courter and non-parental males: $r_{courter}=8$ and $r_{non-courter}=4$. The male with whom the female is nesting gets $r_{courter}/\Sigma{n_{sperm}}$ and additional non-courting males (up to 2) get $(r_{non-courter}*0.5/\Sigma{n_{sperm}})$, where $\Sigma{n_{sperm}}$ is the total number of sperm contributed by all of the males, weighted by the sperm competition factor (0.5 is the default for all males except the chosen male). So, when a female mates with one courter and two non-courters, $\Sigma{n_{sperm}}$ = $r_{courter}$ + 2$*$(0.5$*$$r_{non-courter}$), where $r_{courter}$ = 8 and $r_{non-courter}$ = 4, therefore $\Sigma{n_{sperm}}$ = `r sum(8,rep((0.5*4),2))`. 

That being said, every time a male mates he uses his sperm, so after one mating where a courter fertilizes 50% of the female's 4 eggs, he only has 6 sperm for his next mating. 

In these runs, males who are courters cannot sneak fertilizations.

### 3. Nest Survival

Before the offspring can survive, the nest has to survive. This step is only relevant when parental traits are in the model - if only the courtship trait is specified, then all progeny in the nest survive at this point. When males have the parental trait, if the female has given eggs to a non-parental male (because she chose based on courtship traits), then the nest has a 0% chance of surviving. If the female has given eggs to a parental male, the nest has a 100% chance of surviving. [this is changed from defaults - it was 10% and 90%]

### 4. Density-dependent survival

Once the identities of the surviving nests are known--along with the identities of the parents, including sneaker parents--the offspring are created in the simulation. The offspring are created to fill the full carrying capacity of the population, with the numbers per nest being equally divided among all surviving offspring. This allows the population to maintain a constant population size (prior to viability selection) while maintaining the relative successes of the given genotypes/morphs. 

### 5. Viability selection 

Before becoming adults, the offspring experience viability selection. Courters and parental males are disfavored in viability selection, with a survival probability of `r exp(-0.5/(2*50))`. If an individual is both a courter and a parental male, the survival probability is `r exp(-0.5/(2*50))*exp(-0.5/(2*50))`. Non-courters and non-parental males have survival probabilities of 1. 

### Evaluating equilibrium

After 10000 generations, I begin tracking the change in frequency of the courter and parent traits, and do so for 2000 additional generations. I calculate the variance in the change in frequency over those 2000 generations. I declare an equilibrium ('stasis') has been reached if the last change in frequency of both traits is less than the variance in changes in frequency. 

### Replicates

I ran five independent instances of the model, each of which had four replicates spawned from identical starting conditions. This approach was chosen to reduce the effects of stochasticity in this type of model. In the multi-panel figures below, each row contains the four replicates that originated with identical starting conditions. 

## Single locus models

I ran some simple sets of parameters where I have an expectation for the outcome. In these models, both the courter and parent traits existed and there was a single QTL that was not anchored to a physical chromosomal location and experienced no recombination. I also assumed that nests laid with non-parents have 0% chance of survival and those with parents have 100% chance of survival. In all of these cases, only non-courting males fertilized a nest that did not belong to them.

### Initial parameter combinations 

I first started off with my defaults for the model, which is when courters and parents have a reproductive advantage (they can fertilize 8 eggs compared to the non-courter and non-parent's 4 eggs). The nesting male (regardless of phenotype) experienced a reproductive advantage by fertilizing a higher proportion of the eggs. Furthermore, females always prefer courters to non-courters and only nest with non-courters when they cannot find a courter in the males they evaluate. I therefore expected that the courter/parent morph would dominate and no variation would be maintained.

```{r courterRS, fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=3,fig.width=6.5}
courterRS<-get.morph.freqs(plot.pc.reps(pattern="pcu_1locus_nestBinary_courterRSadvantage.*summary.txt",path="single_locus",cols,make.plot=FALSE))
courterRS$Courter2NonRS<-8/4
bp<-barplot(t(as.matrix(courterRS[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg = gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,
        border=NA)
text(x=bp,y=0.5,srt=90,labels = courterRS$FreqCP)
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```


With the current set of conditions, when males are only permitted to mate once, the non-courter/parent morph is the only one maintained in the population (Fig. \@ref(fig:courterRS)), which is counter to our prediction. However, it does follow our prediction that only parents will be able to be maintained in the population. 

On the other hand, when males are allowed to mate multiply, the courter/parent morph dominates the population but is not always the only morph present (Fig. \@ref(fig:polyCourterRS)).

```{r polyCourterRS, fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=3,fig.width=6.5}
courterRSpoly<-get.morph.freqs(plot.pc.reps(pattern="pcu_1locus_polygyny_nestBinary_courterRSadvantage.*summary.txt",path="single_locus",cols,make.plot=FALSE))
courterRSpoly$Courter2NonRS<-8/4
bp<-barplot(t(as.matrix(courterRSpoly[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,
        border=NA)
text(x=bp,y=0.5,srt=90,labels = courterRSpoly$FreqCP)

par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```




### Combinations to try to maintain multiple morphs

I ran a set of models with the following parameter variations, with my expectation for whether variation should be maintained or not.

```{r}
expTab<-data.frame(Name=c("courterRSadvantage", "equalFitness","onlySpermComp","sneakRSadvantage","sneakRSadvantage_courterRSadvantage"),
                   ParentRS=c(8,4,4,4,4),
                   NonParentRS=c(4,4,4,8,8),
                   CourterRS=c(8,4,4,4,8),
                   NonCourterRS=c(4,4,4,4,4),
                   SpermCompFactor=c(0.5,1,0.5,0.5,0.5),
                   MultipleMorphs=c("No","Yes","Yes","Yes","Yes"))
kable(expTab,booktabs=TRUE,"latex",
      caption = "The different parameter settings used for the models and whether I expected multiple morphs to be maintaned.") %>%
  kable_styling(latex_options=c("scale_down","HOLD_position"))
```


```{r multipleMorphs,fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The top row are runs where males can only mate once and the bottom row are runs where males can mate with multiple females. The top row is for the case when males mate with one female, and the bottom is polygyny. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=6,fig.width=8}
var_patts<-c("pcu_1locus_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_polygyny_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt")

par(mfrow=c(2,length(var_patts)/2),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-get.morph.freqs(plot.pc.reps(pattern=pattern,path="single_locus",cols,make.plot=FALSE))
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,
        border=NA,
        main=gsub("^.*nestBinary_(\\w+)[[:punct:]].*","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```

These runs did not produce as much variation as I expected, and raised several questions:

1. What allows non-courter/parents to dominate in some cases, when they shouldn't be chosen as nesting mates by females?

2. What causes one or another sneaker morph to become present in the population?

3. What causes the variation among runs in terms of the outcomes?

The answers to these three questions are likely to be somewhat linked. 

## Addressing raised questions

First, I tried to understand what was allowing the non-courter/parents to dominate the monogamy models. In the model, females sample 50 males in the population and if they do not find a courter male, they will then mate randomly. This random mating is the only pathway through with non-courter/parent males should be able to mate, because only non-parents are sneakers. To ensure that this is the case, I ran the model turning off the random-mating option, so females do not successfully mate if they cannot find a courter male. In these runs we would expect the dominant morph in the population to be a courter/parent, which we see is the case (Fig. \@ref(fig:multipleMorphsNM)). This figure can be compared to Fig. (\@ref(fig:multipleMorphs)), and in doing so we see that under monogamous conditions the Non-Courter/Parent morph is displaced as the dominant one by the Courter/Parent morph. The polygynous cases are similar to the cases when females can mate randomly if they do not encounter an attractive male.  

```{r multipleMorphsNM,fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. The top row are runs where males can only mate once and the bottom row are runs where males can mate with multiple females. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The numbers in the bars state the frequency of the Courter-Parent morph.", fig.height=6,fig.width=8}
nm_patts<-c("pcu_1locus_nestBinary_nm_courterRSadvantage.*summary.txt",
             "pcu_1locus_nestBinary_nm_equalFitness.*summary.txt",
             "pcu_1locus_nestBinary_nm_onlySpermComp.*summary.txt",
             "pcu_1locus_nestBinary_nm_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_nestBinary_nm_sneakRSadvantage_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt")
par(mfrow=c(2,length(nm_patts)/2),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
nmDat<-lapply(nm_patts,function(pattern){
  dat<-get.morph.freqs(plot.pc.reps(pattern=pattern,path="single_locus",cols,make.plot=FALSE))
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("^.*nestBinary_(\\w+)[[:punct:]].*","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```

The monogamous result suggests that the number of mates a female can search is an important parameter in the model. I would expect that in the non-random mating scenario, the population would crash if I hadn't adjusted the model so that each generation is created in numbers proportional to the produced offspring to maintain a stable population size.

So, what this suggests is that the initial conditions seem to play a role but it doesn't seem to fully explain it. Also, it's odd because when courters start off as more abundant than parents, the non-courter/parent morph is the most successful one, and when parents start off as more frequent the courter/non-parent is the more successful morph. So I looked next into the role thresholds could play, and whether the random assignment of trait values contributes to the random success of one morph or another..


```{r}
par(mfrow=c(3,1))
bp<-barplot(t(as.matrix(courterRS[,c("FreqNcNp", "FreqCNp", "FreqNcP")])),
        col=cols2[c("NCNP","CNP","NCP")],
        names.arg = gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,
        border=NA)
legend(x=5,y=0.04,bty='n',legend = c("Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=3,cex=1.25)
bp<-barplot(t(as.matrix(courterRS1[,c("CourterFreq", "ParentFreq")]))-0.5,
        col=cols[c("courter","parent")],
        names.arg = gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,beside = TRUE,
        border=NA)
legend(y=.04,x=15,xpd=TRUE,c("courter","parent"),col=cols[c("courter","parent")],
       ncol=2,pch=15,bty='n',cex=1.25)
bp<-barplot(t(as.matrix(courterRS1[,c("CourterThresh", "ParentThresh")])),
        col=cols[c("courter","parent")],
        names.arg = gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(courterRS)),
        las=2,beside = TRUE,
        border=NA)
legend(y=1.75,x=15,xpd=TRUE,c("courter","parent"),col=cols[c("courter","parent")],
       ncol=2,pch=15,bty='n',cex=1.25)

```

What about males vs females? In the final generation, we can see that both males and females have the Non-Courter/Parent trait, but only the females were able to successfully mate. This suggests that this variation is maintained through females.

```{r}
traits<-read.delim("single_locus/pcu_1locus_polygyny_nestBinary_courterRSadvantage_1_traits.txt")
table(traits[traits$Gen==12000  & traits$Courter==0 & traits$Parent==1,c("Sex","Pop")])

table(traits[traits$Gen==12000 & traits$Pop==0  & traits$Courter==0 & traits$Parent==1,c("Sex","MateFound")])

```


In the model, females sample 50 males in the population and if they do not find a courter male, they will then mate randomly. This random mating is the only pathway through with non-courter/parent males should be able to mate, because only non-parents are sneakers. To ensure that this is the case, I ran the model turning off the random-mating option, so females do not successfully mate if they cannot find a courter male. In these runs we would expect the dominant morph in the population to be a courter/parent, which we see is the case (Fig. \@ref(fig:multipleMorphsNM)).

```{r multipleMorphsNM,fig.cap="Stacked bar charts showing the frequencies of the four morph types in the final generation of each replicate. Five rounds of the model were run, each with 4 replicates that all started with the same initial conditions, and the numbers on the x-axis refer to which indepedent round these results are from. The top row are runs where males can only mate once and the bottom row are runs where males can mate with multiple females. The top row is for the case when males mate with one female, and the bottom is polygyny.", fig.height=6,fig.width=8}
nm_patts<-c("pcu_1locus_nestBinary_nm_courterRSadvantage.*summary.txt",
             "pcu_1locus_nestBinary_nm_equalFitness.*summary.txt",
             "pcu_1locus_nestBinary_nm_onlySpermComp.*summary.txt",
             "pcu_1locus_nestBinary_nm_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_nestBinary_nm_sneakRSadvantage_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_courterRSadvantage.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_equalFitness.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_onlySpermComp.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_sneakRSadvantage_\\d.*summary.txt",
             "pcu_1locus_polygyny_nm_nestBinary_sneakRSadvantage_courterRSadvantage.*summary.txt")
par(mfrow=c(2,length(nm_patts)/2),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
nmDat<-lapply(nm_patts,function(pattern){
  dat<-get.morph.freqs(plot.pc.reps(pattern=pattern,path="single_locus",cols,make.plot=FALSE))
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("^.*nestBinary_(\\w+)[[:punct:]].*","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2,cex=1.25)

```

