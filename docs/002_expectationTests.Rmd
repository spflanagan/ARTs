---
title: "High-level ARTs Debugging"
output: html_document
author: "Sarah P. Flanagan"
date: "`r format(Sys.time(), '%d %B, %Y')`"

---

The purpose of this model is to understand how genetic architectures of alternative reproductive tactics impact their maintenance in populations. I'm using an individual-based simulation model with different selection scenarios, types of alternative tactics, and genetic architectures (genome-wide additive genetic variance, supergenes, expression networks) To test the model and make sure that everything has been implemented correctly, I'm first testing to ensure that the model produces the expected results without the genetic architectures.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir='../results/')
```
```{r, echo=FALSE}
library(knitr)
library(RColorBrewer)
library(scales)
read_chunk("../R/002_expectationTests.R")
cols<-c(courter="#33a02c",parent="#1f78b4",cpref="#b2df8a",ppref="#a6cee3")
cols2<-c('#a1dab4','#41b6c4','#2c7fb8','#253494')
```


Based on previous theoretical work, the following expectations exist:
```{r expecations, echo=FALSE}
expectations<-data.frame(Scenario=c("Courtship trait", "Parental Trait","Courtship and Parental Traits",
                                    "Courtship Trait + Neg Freq Dep Sel", "Parental Trait + Neg Freq Dep Sel",
                                    "Parental Trait and courtship Trait + Neg Freq Dep Sel"),
                         Expected_Outcome=c("Both alts maintained if costs = benefits","Both alts maintained if costs = benefits",
                                            "Coevolution of both alts, and both alts maintained if costs = benefits",
                                            "both alts maintained", "?","?"))
kable(expectations, caption = "Expected outcomes")
```

One caveat to comparing to previous work is that in my model the parental and courtship traits have a trade-off, and I haven't found a model incorporated tradeoffs and negative frequency dependent selection.

But we can look at what happens with the runs that I've done *(note that these are individual runs, not averages of multiple runs)*. Let's start with the ones that do not have a genetic architecture.

## Overview of the model 

A female samples 50 males and choose a male based on their courtship traits. If there are no courtship traits in the model, she chooses based on parental traits. If she does not encouter an acceptable male, she does not nest. If she encounters multiple equally-acceptable males, she randomly selects one of them.  

Once a female decides to nest, up to three males can fertilize the nest. The male with whom the female is nesting gets 8/$\Sigma{n_{sperm}}$ and additional sneaker males (2) get $(4*0.5/\Sigma{n_{sperm}})$, where $\Sigma{n_{sperm}}$ is the total number of sperm contributed by all of the males, weighted by the sperm competition factor (0.5 in this case, for all males except the nesting male). So, when a female mates with one courter and two sneakers, $\Sigma{n_{sperm}}$ = $r_{courter}$ + 2$*$(0.5$*$$r_{sneaker}$), where $r_{courter}$ = 8 and $r_{sneaker}$ = 4, therefore $\Sigma{n_{sperm}}$ = `r sum(8,rep((0.5*4),2))`. 

Before the babies can survive, the nest has to survive. This only occurs when parental traits are in the model. If the female has given eggs to a non-parental male (because she chose based on courtship traits), then the nest has a 10% chance of surviving. If the female has given eggs to a parental male, the nest has a 90% chance of surviving. 

Then the offspring experience viability selection. Viability selection favors non-courters and sneakers (non-parentals). Once viability selection has been imposed, individuals die or survive randomly, and the next generation gets a chance to mate.

## No genetic basis to traits

In these cases, males are randomly assigned a trait value from a normal distribution with a standard deviation of 0.5. This trait value is compared to the population-wide threshold to determine whether the individual is a courter or a sneaker. The threshold is set in the initial generation of the model as the mean of the male trait values at that point. In these iterations, the threshold is static. 

To choose a nest, females prefer "better" males (courting and/or parental males). If none of the males a female encounters are a courter (or a parental when courtship traits are absent), she does not nest. 

In these models, courters and parental males are disfavored in viability selection, with a survival probability of `r exp(-0.5/(2*50))`. If an individual is both a courter and a parental male, the survival probability is `r exp(-0.5/(2*50))*exp(-0.5/(2*50))`. Non-courters and non-parental males have survival probabilities of 1.

### Males have courtship traits

Females choose nests based on whether the male is a courter or not. Because parental care is not incorporated in this model, all nests survive.

```{r CourterConditionalData, echo=FALSE}
```
```{r plot_courter_conditional, echo=FALSE}
plot(cc.sum$CourterFreq,lwd=2,xlab="Generations",ylab="Frequency of Courting Males",
     bty="L",type="l",ylim = c(0,1),col=cols["courter"])
```


### Males have parental traits

Females choose nests based on whether males are parentals or not, and only mate with parental males. Parental males provide care that allows nests to have a 90% chance of survival. 

```{r parental_traits_conditional, echo=FALSE}
pc.sum<-read.delim("parent-conditional_summary.txt")
plot(pc.sum$ParentFreq,lwd=2,xlab="Generations",ylab="Frequency of Parental Males",
     bty="L",type="l",ylim = c(0,1),col=cols["parent"])
```


### Males have both courtship and parental traits

Females choose nests based on males' courtship morph (nest with courting males only), and then the survival of the nest depends on whether the courting male is also a parental male. If the chosen male is a parental male, the nest has a 90% chance of survival. Otherwise, it only has a 10% chance.

```{r parentalCourtship_conditional, echo=FALSE}
pcc.sum<-read.delim("parent-courter-conditional_summary.txt")
plot(pcc.sum$ParentFreq,lwd=2,xlab="Generations",ylab="Frequency of Parental Males",
     bty="u",type="l",ylim = c(0,1),col=alpha(cols["parent"],0.75))
points(pcc.sum$CourterFreq,lwd=2,type="l",col=alpha(cols["courter"],0.75))
mtext("Frequency of Courtship Males",4)
```

### Courtship + Negative Frequency Dependent Selection

In this case, the female preference is based on the frequency of the courtship morphs in the population - females prefer the *less frequent* morph. Everything else is the same as above; males are assigned a trait value at random (it's not inherited), all nests survive since parental care is not incorporated in this model, and courters and parental males are disfavored in viability selection.

```{r courtship_nfds,echo=FALSE}
cn<-read.delim("courter-conditional_nfds_summary.txt")
plot(cn$CourterFreq,lwd=2,xlab="Generations",ylab="Frequency of Courtship Males",
     bty="l",type="l",ylim=c(0,1),col=alpha(cols["courter"],0.75))
```

### Parental Males + Negative Frequency Dependent Selection

In this case, the female preference is based on the frequency of the parental morphs in the population - females prefer the *less frequent* morph. Everything else is the same as above; males are assigned a trait value at random (it's not inherited), nests have a 90% chance of survival, and courters and parental males are disfavored in viability selection.

```{r parent_nfds,echo=FALSE}
pn<-read.delim("parent-conditional_nfds_summary.txt")
plot(pn$ParentFreq,lwd=2,xlab="Generations",ylab="Frequency of Parental Males",
     bty="l",type="l",ylim=c(0,1),col=alpha(cols["parent"],0.75))
```

### Courtship + Parental Males + Negative Frequency Dependent Selection

In this case, the female preference is based on the frequency of the courtship morphs in the population - females prefer the *less frequent* morph. Everything else is the same as above; males are assigned a trait value at random (it's not inherited), parental males' nests survive with a probability of 90% and non-parental males' nests survive with a probability of 10%, and courters and parental males are disfavored in viability selection.

```{r parent_courtship_nfds,echo=FALSE}
pcn<-read.delim("parent-courter-conditional_nfds_summary.txt")
plot(pcn$CourterFreq,lwd=2,xlab="Generations",ylab="Frequency of Courtship Males",
     bty="u",type="l",ylim=c(0,1),col=alpha(cols["courter"],0.75))
points(pcn$ParentFreq,lwd=2,type="l",col=alpha(cols["parent"],0.75))
mtext(text = "Frequency of Parental Males",side=4)
```

## Unlinked additive genetic variance

In these cases, the traits are encoded by a number of loci, whose alleles contribute additively to determine the trait value. These alleles are all freely recombining and are not adhered to any physical genomic location (aka this is a classical quantitative genetics approach). The overall trait value is compared to a population-level threshold (which is static, in these cases), and if the trait value is above the threshold the male takes the parent or courter morph and if it is below he does not. 

### Courter trait

Females choose nests based on whether the male is a courter or not, and they all prefer courters all of the time. Because parental care is not incorporated in this model, all nests survive.

```{r unlinked_courter}
cng.sum<-read.delim("courter-nogenetics_summary.txt")
plot(cng.sum$CourterFreq,lwd=2,xlab="Generations",ylab="Frequency of Courting Males",
     bty="L",type="l",ylim = c(0,1),col=cols["courter"])
cng.pop<-read.delim("courter-nogenetics_popdyn.txt")
plot(cng.pop$NumMal,col=alpha("navy",0.5),ylim=c(0,1000))
points(cng.pop$NumMal,col=alpha("violetred",0.5),cex=0.5,pch=19)
cng.traits<-read.delim("courter-nogenetics_traits.txt")

```



### Parental traits

Females randomly select males to nest with. Parental males provide care that allows nests to have a 90% chance of survival. 

```{r parental_nogenetics, echo=FALSE}
png.sum<-read.delim("parent-nogenetics_summary.txt")
plot(png.sum$ParentFreq,lwd=2,xlab="Generations",ylab="Frequency of Parental Males",
     bty="L",type="l",ylim = c(0,1),col=cols["parent"])
```


### Courtship and Parental Traits

Females choose nests based on males' courtship morph (nest with courting males only), and then the survival of the nest depends on whether the courting male is also a parental male. If the chosen male is a parental male, the nest has a 90% chance of survival. Otherwise, it only has a 10% chance.

```{r parentalCourtship_nogenetics, echo=FALSE}
pcng.sum<-read.delim("parent-courter-nogenetics_summary.txt")
par(mar=c(4,4,1,4))
plot(pcng.sum$ParentFreq,lwd=2,xlab="Generations",ylab="",
     bty="u",type="l",ylim = c(0,1),col=alpha(cols["parent"],0.75),las=1)
points(pcng.sum$CourterFreq,lwd=2,type="l",col=alpha(cols["courter"],0.75))
axis(4,las=1)
mtext("Frequency of Courtship Males",4,line=2.5,col=cols["courter"])
mtext("Frequency of Parental Males",2,line=2.5,col=cols["parent"])
```

Both are maintained at a frequency a little above 50%

```{r courtParent_rs,echo=FALSE}
ymax<-round(max(pcng.sum$ParentW,pcng.sum$NonParentW,pcng.sum$CourterW,pcng.sum$NonCourterW)+1)
par(mar=c(4,4,1,4),mfrow=c(2,1))
plot(pcng.sum$ParentW,lwd=2,xlab="Generations",ylab="Parental Reproductive Success",
     bty="u",type="l",ylim = c(0,ymax),col=alpha(cols["parent"],0.75),las=1)
points(pcng.sum$NonParentW,lwd=2,lty=3,type="l",col=alpha(cols["parent"],0.75))
points(pcng.sum$NonParentW,lwd=2,lty=3,type="l",col=alpha("grey",0.75))
plot(pcng.sum$CourterW,xlab="Generations",ylab="Courter Reproductive Success",
     bty="u",lwd=2,type="l",col=alpha(cols["courter"],0.75),ylim = c(0,ymax))
points(pcng.sum$NonCourterW,lwd=2,lty=3,type="l",col=alpha(cols["courter"],0.75))
points(pcng.sum$NonCourterW,lwd=2,lty=3,type="l",col=alpha("grey",0.75))
legend("topright",bty='n',legend=c("Preferred","Not Preferred"),lty=c(1,2),col="darkgrey",lwd=2)
```

So, although courting males have lower reproductive success, they're at higher frequency in the population, and parental males are at low frequency. What?!?

Let's look for a correlation between traits. Because these are discrete trait characters, it's a bit wonky to look at. I'm going to add an output for the actual trait values - then I can create a nice landscape. 

```{r courtParent_traits,echo=FALSE}
pcng.traits<-read.delim("parent-courter-nogenetics_traits.txt")
pcng.traits$Morph<-factor(paste(pcng.traits$Courter,pcng.traits$Parent,sep=","))
rcols<-colorRampPalette(cols)(25)
plot(jitter(pcng.traits$Courter,1.5),jitter(pcng.traits$Parent,1.5),
     cex=((pcng.traits$LifetimeRS/max(pcng.traits$LifetimeRS))+1),xlim=c(-0.05,1.05),ylim=c(-0.05,1.05),
     axes=F,xlab="",ylab="",pch=19,col=alpha(cols2[pcng.traits$Morph],0.75),lwd=2)
text(x=c(0,1),y=-0.04,c("Non-Courter","Courter"),xpd=TRUE)
text(x=-0.1,y=c(0,1),c("Non-Parent","Parent"),xpd=TRUE,srt=90)

```

Ok, so it looks like all of the individuals have either one trait or the other - a negative correlation between the two. 

### Courtship + Negative Frequency Dependent Selection

In this case, the female preference is based on the frequency of the courtship morphs in the population - females prefer the *less frequent* morph. Everything else is the same as above; all nests survive since parental care is not incorporated in this model, and courters and parental males are disfavored in viability selection.

```{r courtship_nogenetics_nfds,echo=FALSE}
cnng<-read.delim("courter-nogenetics-nfds_summary.txt")
plot(cnng$CourterFreq,lwd=2,xlab="Generations",ylab="Frequency of Courtship Males",
     bty="l",type="l",ylim=c(0,1),col=alpha(cols["courter"],0.75))
```

### Parental Males + Negative Frequency Dependent Selection

In this case, the female preference is based on the frequency of the parental morphs in the population - females prefer the *less frequent* morph. Everything else is the same as above; nests have a 90% chance of survival, and courters and parental males are disfavored in viability selection.

```{r parent_nogenetics_nfds,echo=FALSE}
pnng<-read.delim("parent-nogenetics-nfds_summary.txt")
plot(pnng$ParentFreq,lwd=2,xlab="Generations",ylab="Frequency of Parental Males",
     bty="l",type="l",ylim=c(0,1),col=alpha(cols["parent"],0.75))
```

### Courtship + Parental Males + Negative Frequency Dependent Selection

In this case, the female preference is based on the frequency of the courtship morphs in the population - females prefer the *less frequent* morph. Everything else is the same as above; parental males' nests survive with a probability of 90% and non-parental males' nests survive with a probability of 10%, and courters and parental males are disfavored in viability selection.

```{r unlinked_parent_courtship_nfds,echo=FALSE}
pcnng<-read.delim("parent-courter-nogenetics-nfds_summary.txt")
plot(pcnng$CourterFreq,lwd=2,xlab="Generations",ylab="Frequency of Courtship Males",
     bty="u",type="l",ylim=c(0,1),col=alpha(cols["courter"],0.75))
points(pcnng$ParentFreq,lwd=2,type="l",col=alpha(cols["parent"],0.75))
mtext(text = "Frequency of Parental Males",side=4)
```

### Comparing multiple runs

I ran the model with 10 replicates of each of these sets, and now I can look at the ending frequency of each morph.

```{r get_summary,echo=FALSE}
files<-list(list.files(pattern="^courter-nogenetics_\\d+_summary.txt"),
            list.files(pattern="^parent-nogenetics_\\d+_summary.txt"),
            list.files(pattern="^parent-courter-nogenetics_\\d+_summary.txt"),
            list.files(pattern="^courter-nogenetics-nfds_\\d+_summary.txt"),
            list.files(pattern="^parent-nogenetics-nfds_\\d+_summary.txt"),
            list.files(pattern="^parent-courter-nogenetics-nfds_\\d+_summary.txt"))

summary<-lapply(files,function(cat){
  dat<-do.call(rbind,lapply(cat,function(file){
    summ<-read.delim(file)
    last.freqs<-sum[nrow(sum),c("ParentFreq","CourterFreq","FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")]
    scen<-gsub("^(\\w+.*)_\\d+_summary.txt","\\1",file)
    last.freqs$scenario<-scen
    return(last.freqs)
  }))
  result<-cbind(colMeans(dat[,1:6]),unique(dat$scenario))
  return(result)
}) #this still needs to be tested once I have the actual data!
```

## Linked additive genetic variance

### Courter Trait

```{r CourterTraitFiles,eval=FALSE}
```
```{r PlotCourterTraits,eval=FALSE}
```
```{r PlotCourterAlleles, eval=FALSE}
```

### Parent Trait

```{r ParentTrait, eval=FALSE}
```

### Frequency-Dependent Preference

```{r FrequencyDependentPreference, eval=FALSE}
```

