---
title: "Comparing models with different genetics parameters"
author: "Sarah P. Flanagan"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: yes
    number_sections: no
    template: manuscript.latex
    toc: yes
    toc_depth: 2
spacing: singlespacing
fontsize: 11pt
capsize: normalsize
documentclass: article
footerdate: yes
graphics: yes
csl: evolution.csl
editor_options:
  chunk_output_type: console
---

The purpose of this model is to understand how genetic architectures of alternative reproductive tactics impact their maintenance in populations. I'm using an individual-based simulation model with different selection scenarios, types of alternative tactics, and genetic architectures (genome-wide additive genetic variance, supergenes, expression networks). To explore the parameter space, I'm also using a mathematical model without the genetic architectures to identify regions of parameter space where we expect multiple morphs to be maintained. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,out.extra='',fig.pos="H",dpi=200,fig.height = 7,fig.width = 7)
knitr::opts_knit$set(root.dir='../results/') #change
```
```{r opts, echo = FALSE}
library(knitr)
knitr::opts_chunk$set(
  fig.path = "../figs/"
)
```
```{r librarysetup, echo=FALSE,echo=FALSE,message=FALSE}
library(RColorBrewer)
library(scales)
library(sm)
library(kableExtra)
library(plotly)
library(dplyr)
library(vegan)
library(tidyr)
source("../R/002_freq_functions.R")

source("../morph_predictions/check_freqs.R")
source("../morph_predictions/morph_gens_ns.R")

cols<-c(courter="#33a02c",parent="#1f78b4",cpref="#b2df8a",ppref="#a6cee3")
cols2<-c(CP='#d7191c',NCP='#fdae61',CNP='#abd9e9',NCNP='#2c7bb6')
```
```{r baseCols}
base_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                   "FreqNcP","FreqCP","Courter2NonRS","Parent2NonSurvival")
poly_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                    "FreqNcP","FreqCP","Polygyny")

```



## Low diversity parameter space

The [results from the mathematical model](https://spflanagan.shinyapps.io/morph_predictions/) were inspected to identify parameter regions where multiple morphs were *not* maintained. I focused on parameter sets when morphs had equal initial frequencies, as the simulation model initiates populations with nearly equal frequencies of the morphs. I selected the low diversity parameters in Table \@ref(tab:lowDivParams) to implement in the simulation model with a single locus underpinning the courter and parent traits. 

```{r lowDivParams}
highDivParams<-data.frame(
  parameter = c("r (in shiny app)",
                "r_CP",
                "r_CN",
                "r_NP",
                "r_NN",
                "c",
                "number of sneakers"),
  value = c( 2, 
             8,
             8,
             4,
             4,
             0.5,
             2)
)
kable(highDivParams, "latex",booktab=TRUE,
      caption="Table of parameters selected to create a low-diversity population. All morphs started at equal frequencies.") %>%
  kable_styling(latex_options = "HOLD_position")

```

### QTLs

```{r lowDivGenetics}
lowDiv<-get.morph.freqs(plot.pc.reps(pattern="lowDiversity.*monogamy_nm.*summary.txt",
                                     path="/mnt/BigData/fixedART-results/qtls",
                                     cols,make.plot=FALSE))
lnames<-rownames(lowDiv)
```

```{r}
qs<-unique(gsub(".*lowDiversity_.*_q(\\d+)_c(\\d)_\\d_summary.txt_\\d","\\1",lnames))
cs<-unique(gsub(".*lowDiversity_.*_q(\\d+)_c(\\d)_\\d_summary.txt_\\d","\\1",lnames))
```

```{r lowDivQTLs16, fig.cap="Final generation frequencies based on the model with 16 QTLs, with parameters that are expected to result in no diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[1]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r lowDivQTLs32, fig.cap="Final generation frequencies based on the model with 32 QTLs, with parameters that are expected to result in no diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[2]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r lowDivQTLs64, fig.cap="Final generation frequencies based on the model with 64 QTLs, with parameters that are expected to result in no diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[3]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r lowDivQTLs8, fig.cap="Final generation frequencies based on the model with 8 QTLs, with parameters that are expected to result in no diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[4]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

### Supergenes


```{r lowDivGenetics2}
lowDiv<-get.morph.freqs(plot.pc.reps(pattern="lowDiversity.*monogamy_nm.*summary.txt",
                                     path="/mnt/BigData/fixedART-results/supergene",
                                     cols,make.plot=FALSE))
lnames<-rownames(lowDiv)
```

```{r}
qs<-unique(gsub(".*lowDiversity_.*_q(\\d+)_c(\\d)_\\d_summary.txt_\\d","\\1",lnames))
cs<-unique(gsub(".*lowDiversity_.*_q(\\d+)_c(\\d)_\\d_summary.txt_\\d","\\1",lnames))
```

```{r lowDivQTLs16super, fig.cap="Final generation frequencies based on the model with 16 QTLs in a supergene, with parameters that are expected to result in no diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[1]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r lowDivQTLs32super, fig.cap="Final generation frequencies based on the model with 32 QTLs in a supergene, with parameters that are expected to result in no diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[2]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r lowDivQTLs64super, fig.cap="Final generation frequencies based on the model with 64 QTLs in a supergene, with parameters that are expected to result in no diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[3]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r lowDivQTLs8 super, fig.cap="Final generation frequencies based on the model with 8 QTLs in a supergene, with parameters that are expected to result in no diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[4]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```


## High diversity parameter space

The [results from the mathematical model](https://spflanagan.shinyapps.io/morph_predictions/) were inspected to identify parameter regions where multiple morphs were maintained. I focused on parameter sets when morphs had equal initial frequencies, as the simulation model initiates populations with nearly equal frequencies of the morphs. I selected the high-diversity parameters in Table \@ref(tab:highDivParams) to implement in the simulation model with a single locus underpinning the courter and parent traits. 

```{r highDivParams}
highDivParams<-data.frame(
  parameter = c("r (in shiny app)",
                "r_CP",
                "r_CN",
                "r_NP",
                "r_NN",
                "c",
                "number of sneakers"),
  value = c( 0.75, 
             6,
             6,
             8,
             8,
             0.7,
             2)
)
kable(highDivParams, "latex",booktab=TRUE,
      caption="Table of parameters selected to create a high-diversity population. All morphs started at equal frequencies.") %>%
  kable_styling(latex_options = "HOLD_position")

```

### QTLs

```{r highDivGenetics}
lowDiv<-get.morph.freqs(plot.pc.reps(pattern="highDiversity.*monogamy_nm.*summary.txt",
                                     path="/mnt/BigData/fixedART-results/qtls",
                                     cols,make.plot=FALSE))
lnames<-rownames(lowDiv)
```

```{r}
qs<-unique(gsub(".*highDiversity_.*_q(\\d+)_c(\\d)_\\d_summary.txt_\\d","\\1",lnames))
cs<-unique(gsub(".*highDiversity_.*_q(\\d+)_c(\\d)_\\d_summary.txt_\\d","\\1",lnames))
```

```{r highDivQTLs16, fig.cap="Final generation frequencies based on the model with 16 QTLs, with parameters that are expected to result in high diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[1]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r highDivQTLs32, fig.cap="Final generation frequencies based on the model with 32 QTLs, with parameters that are expected to result in high diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[2]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r highDivQTLs64, fig.cap="Final generation frequencies based on the model with 64 QTLs, with parameters that are expected to result in high diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[3]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r highDivQTLs8, fig.cap="Final generation frequencies based on the model with 8 QTLs, with parameters that are expected to result in high diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[4]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

### Supergenes


```{r highDivGenetics2}
lowDiv<-get.morph.freqs(plot.pc.reps(pattern="highDiversity.*monogamy_nm.*summary.txt",
                                     path="/mnt/BigData/fixedART-results/supergene",
                                     cols,make.plot=FALSE))
lnames<-rownames(lowDiv)
```

```{r}
qs<-unique(gsub(".*highDiversity_.*_q(\\d+)_c(\\d)_\\d_summary.txt_\\d","\\1",lnames))
cs<-unique(gsub(".*highDiversity_.*_q(\\d+)_c(\\d)_\\d_summary.txt_\\d","\\1",lnames))
```

```{r highDivQTLs16super, fig.cap="Final generation frequencies based on the model with 16 QTLs in a supergene, with parameters that are expected to result in high diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[1]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r highDivQTLs32super, fig.cap="Final generation frequencies based on the model with 32 QTLs in a supergene, with parameters that are expected to result in high diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[2]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r highDivQTLs64super, fig.cap="Final generation frequencies based on the model with 64 QTLs in a supergene, with parameters that are expected to result in high diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[3]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

```{r highDivQTLs8super, fig.cap="Final generation frequencies based on the model with 8 QTLs in a supergene, with parameters that are expected to result in high diversity based on the mathematical model. In 'monogamy' cases, the males were constrained to only accept eggs from one female into their nests, whereas under 'polygyny' males could mate with multiple females. In both cases females mated once. Parameter settings lablled with 'nm' were runs where females did not mate if they could not find a suitable mate (i.e., if no courters were available)."}

var_patts<-unique(gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",
                       lnames[grep(paste0("q",qs[4]),lnames)]))


par(mfrow=c(2,ceiling(length(var_patts)/2)),oma=c(3,1,4,1),mar=c(3,1,4,1),xpd=TRUE)
varDat<-lapply(var_patts,function(pattern){
  dat<-lowDiv[grep(paste0(pattern,"_\\d"),rownames(lowDiv)),]
  bp<-barplot(t(as.matrix(dat[,c("FreqNcNp", "FreqCNp", "FreqNcP", "FreqCP")])),
        col=cols2[c("NCNP","CNP","NCP","CP")],
        names.arg =gsub("^.*(\\d)_summary.txt.*$","\\1",rownames(dat)),
        las=2,
        border=NA,
        main=gsub("qtls_monogamy_nm_(.*)","\\1",pattern))
  text(x=bp,y=0.5,srt=90,labels = dat$FreqCP)

  return(dat)
})
par(fig=c(0, 1, 0, 1), oma=c(0, 0, 0, 0), mar=c(0, 0, 0, 0), new=TRUE)
plot(0,0, type='n', bty='n', xaxt='n', yaxt='n')
legend("top",bty='n',legend = c("Courter/Parent","Courter/Non-parent","Non-courter/Parent","Non-courter/Non-parent"),
       col=cols2[c("CP","CNP","NCP","NCNP")],pch=15,xpd = TRUE,ncol=2)

```

# Selection on traits

```{r traitsSelection, warning=FALSE}
traits_files<-c(
  list.files(path="../fixedART-results/qtls/", pattern="_traits.txt", full.names = TRUE),
  list.files(path="../fixedART-results/supergene/", pattern="_traits.txt", full.names = TRUE))

seldat<-lapply(traits_files, function(filename){
  traits<-read.delim(filename)
  seldat<-do.call(rbind,by(traits, traits$Pop, function(popdat){
    
    gens<-as.matrix(do.call(rbind,by(popdat, popdat$Gen, function(dat){
      
      # selection on males
      maldat<-dat[dat$Sex=="MALE",]
      courterLM<-summary(lm(maldat$Courter ~ maldat$LifetimeRS))
      courterNumLM<-summary(lm(maldat$CourtTrait ~ maldat$LifetimeRS))
      parentLM<-summary(lm(maldat$Parent ~ maldat$LifetimeRS))
      parentNumLM<-summary(lm(maldat$ParentTrait ~ maldat$LifetimeRS))
      
      return(c(
        court_cat_b0 = courterLM$coefficients[1,1],
        court_cat_b0_se = courterLM$coefficients[1,2],
        court_cat_b0_p = courterLM$coefficients[1,4],
        court_cat_b1 = courterLM$coefficients[2,1],
        court_cat_b1_se = courterLM$coefficients[2,2],
        court_cat_b1_p = courterLM$coefficients[2,4],
        
        parent_cat_b0 = parentLM$coefficients[1,1],
        parent_cat_b0_se = parentLM$coefficients[1,2],
        parent_cat_b0_p = parentLM$coefficients[1,4],
        parent_cat_b1 = parentLM$coefficients[2,1],
        parent_cat_b1_se = parentLM$coefficients[2,2],
        parent_cat_b1_p = parentLM$coefficients[2,4]
      ))
    })))
    
    gens<-cbind(gens, 
                gen=as.numeric(rownames(gens)),
                pop= as.numeric(popdat$Pop[1]))
    return(gens)
  }))
  
  return(seldat)
})


```

```{r selectionGradients}
plot(-0.25:0.25, -0.25:0.25, 
     type='n',
     xlim=c(-.25,0.25),
     ylim=c(-.25,0.25),
     xlab="Selection gradient on courter trait",
     ylab="Selection gradient on parent trait",
     bty='n', 
     axes=FALSE)
abline(a=0,b=1,col="grey",lwd=2,lty=2)
abline(a=0,b=-1,col="grey",lwd=2,lty=2)
tmp<-lapply(seldat, function(dat){
  
  points(dat[,"court_cat_b1"],
         dat[,"parent_cat_b1"],
         pch=c(15,16)[as.factor(dat[,"gen"])],
         col=scales::alpha(c("forest green","cornflower blue")[as.factor(dat[,"gen"])],0.5)
  )
  arrows(
    x0 = dat[,"court_cat_b1"] - dat[,"court_cat_b1_se"],
    x1 = dat[,"court_cat_b1"] + dat[,"court_cat_b1_se"],
    y0 = dat[,"parent_cat_b1"],
    y1 = dat[,"parent_cat_b1"],
    code = 0,
    col=scales::alpha(c("forest green","cornflower blue")[as.factor(dat[,"gen"])],0.5)
      )
    arrows(
    x0 = dat[,"court_cat_b1"] ,
    x1 = dat[,"court_cat_b1"] ,
    y0 = dat[,"parent_cat_b1"] - dat[,"parent_cat_b1_se"],
    y1 = dat[,"parent_cat_b1"] + dat[,"parent_cat_b1_se"],
    code = 0,
    col=c("forest green","cornflower blue")[as.factor(dat[,"gen"])]
      )
  
})
legend("top",
       bty='n',
       pch=c(15,16),
       col=c("forest green","cornflower blue"),
       legend=c("Generation 0", "Generation 1200"),
       ncol=2)
```

What's driving these different sets of selection patterns?


