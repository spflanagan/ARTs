---
title: "Ternary plots for ARTs results"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,out.extra='',fig.pos="H",dpi=200,fig.height = 7,fig.width = 7)
knitr::opts_knit$set(root.dir='../results/') #change
```
```{r opts, echo = FALSE}
library(knitr)
knitr::opts_chunk$set(
  fig.path = "../figs/",
  dev="png"
)
```
```{r librarysetup, echo=FALSE,echo=FALSE,message=FALSE}
library(RColorBrewer)
library(scales)
library(sm)
library(kableExtra)
library(plotly)
library(dplyr)
library(vegan)
library(tidyr)
library(Ternary)
source("../R/002_freq_functions.R")
tmp<-sapply(list.files(path="../../spfTools/R/",full.names = TRUE),source)
source("../morph_predictions/check_freqs.R")
source("../morph_predictions/morph_gens_ns.R")

```
```{r baseCols}
cols<-c(courter="#33a02c",parent="#1f78b4",cpref="#b2df8a",ppref="#a6cee3")
cols2<-c(CP='#d7191c',NCP='#fdae61',CNP='#abd9e9',NCNP='#2c7bb6')
base_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                   "FreqNcP","FreqCP","Courter2NonRS","Parent2NonSurvival")
poly_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                    "FreqNcP","FreqCP","Polygyny")
divcols<-c(low="#e78ac3",high="#ffd92f")

```

```{r dataConversionFXN}
morphs_to_ternary<-function(pattern, path){
  data<-get.morph.freqs(plot.pc.reps(pattern=pattern,path=path,cols,make.plot=FALSE))
  data_points<-apply(data,
                   1,
                   function(dat){
                     out<-dat[c("FreqCP","FreqNcP","FreqNcNp")]
                     return(as.numeric(out))
                   },
                   simplify = FALSE)
  return(data_points)
}

```
```{r makeTernaryMorphsFXN}
# made with inspiration from this tutorial: https://cran.r-project.org/web/packages/Ternary/vignettes/Ternary.html
morphs_ternary_plot<-function(){
  TernaryPlot(atip="CP",
            btip="NP",
            ctip="NN",
            alab="Courter/Parent",
            blab="Noncourter/Parent",
            clab="Noncourter/Nonparent",
            grid.lines=4,
            grid.minor.lines = 1,
            grid.lty = "dotted",
            grid.minor.lty = "dotted",
            lab.col=cols2[c(1,2,4)],
            tip.col=cols2[c(1,2,4)])
}
```


## Single locus simulations

These simulations had three diversity settings but also four mating systems, so I'll use a mix of colors and points to show the differences.

```{r singleLocusData}
lowDiv<-morphs_to_ternary(pattern="lowDiversity.*summary.txt",path="single_locus")
highDiv<-morphs_to_ternary(pattern="highDiversity_.*summary.txt", path="single_locus")
highDivStrict<-morphs_to_ternary(pattern="highDiversityStrict.*summary.txt",path="single_locus")

# remove ones with no viability sel or random mating
lowDiv<-lowDiv[grep("v0",grep("RM", names(lowDiv), invert=TRUE, value=TRUE), invert=TRUE, value=TRUE)] 
highDiv<-highDiv[grep("v0",grep("RM", names(highDiv), invert=TRUE, value=TRUE), invert=TRUE, value=TRUE)]
highDivStrict<-highDivStrict[grep("v0",grep("RM", names(highDivStrict), invert=TRUE, value=TRUE), invert=TRUE, value=TRUE)]
```

```{r singleLocusMSinfo}
# extract corresponding mating system info
low_patts<-gsub(".*lowDiversity_(.*)_\\d_summary.txt_\\d","\\1",names(lowDiv))
low_patts<-grep("v0",grep("RM", low_patts, invert=TRUE, value=TRUE), invert=TRUE, value=TRUE)

high_patts<-gsub(".*highDiversity_(.*)_\\d_summary.txt_\\d","\\1",names(highDiv))
high_patts<-grep("v0",grep("RM", high_patts, invert=TRUE, value=TRUE), invert=TRUE, value=TRUE)

strict_patts<-gsub(".*highDiversityStrict_(.*)_\\d_summary.txt_\\d","\\1",names(highDivStrict))
strict_patts<-grep("v0",grep("RM", strict_patts, invert=TRUE, value=TRUE), invert=TRUE, value=TRUE)

```


```{r singleLocusPlot}

ms_cols<-c(monogamy='#e08214',
           monogamy_nm='#b35806',
           polygyny='#998ec3',
           polygyny_nm='#5e3c99')

# create the base
par(mar=c(0,0,0,0))
morphs_ternary_plot()

# add the points
AddToTernary(
  points,
  lowDiv,
  col=ms_cols[low_patts],
  pch=6,
  lwd=2,
  cex=2 # add color based on param values
)

AddToTernary(
  points,
  highDiv,
  col=ms_cols[high_patts],
  pch=0,
  lwd=2,
  cex=2 # add color based on param values
)

AddToTernary(
  points,
  highDivStrict,
  col=ms_cols[strict_patts],
  pch=5,
  lwd=2,
  cex=2 # add color based on param values
)

outer_legend("topleft",
       c(names(ms_cols),"low", "high", "strict high"),
       col=c(ms_cols, rep("dark grey",3)),
       pch=c(rep(1,4),6,0,5),
       pt.cex=2,
       bty='n',
       ncol=2,
       pt.lwd=2)


```

## Polygenic inheritance

The main variables I want to show with the polygenic inheritance are the genetic architecture (QTLs vs supergenes with diff props) and number of chromosomes. I could also do number of QTLs -- that wasn't shown in the main manuscript, as I showed representative images from the 8 QTLs scenarios. How do I want to show this? 

- In other figures, I've used circles and triangles for QTLs and supergenes, respectively
- I could use colors to show num of chromosomes and do different triangles for each architecture
- scale points based on the number of QTLs?

```{r}
final_freqs<-read.csv("../results/morph_freqs_summary.csv")
final_freqs$rep<-gsub("^.*Diversity_(.*)_pheno.csv","\\1",final_freqs$file)

# extract the relevant info for plotting
final_freqs$nqtl<-as.numeric(gsub("^.*q(\\d+)_.*$","\\1",final_freqs$rep))
final_freqs$nchrom<-as.factor(gsub("^.*c(\\d+)_.*$","\\1",final_freqs$rep))
final_freqs$arch<-gsub("^.*results\\/(\\w+)\\/.*$","\\1",final_freqs$file)
final_freqs$arch[final_freqs$arch=="supergene"]<-gsub("^.*(prop\\d+\\.\\d+).*$","\\1",final_freqs$arch[final_freqs$arch=="supergene"])
```
```{r}
chr_col<-c(
  "#cccccc",
  "#969696",
  "#636363"
)
names(chr_col)<-levels(final_freqs$nchrom)
```


I'll start with just the QTL options.

```{r}
qtls<-final_freqs[which(final_freqs$arch=="qtls"),]


# convert the data into the list format
qtl_points<-apply(qtls,
                   1,
                   function(dat){
                     out<-dat[c("CP","P","NON")]
                     return(as.numeric(out))
                   },
                   simplify = FALSE)
```


```{r}
par(mar=c(0,0,0,0))
morphs_ternary_plot()

# add the points
AddToTernary(
  points,
  qtl_points,
  bg=alpha(chr_col[qtls$nchrom],0.5),
  col=chr_col[qtls$nchrom],
  pch=16,
  lwd=2,
  cex=sqrt(qtls$nqtl)/4
)

outer_legend("topleft",
       names(chr_col),
       col=chr_col,
       pch=,
       pt.cex=2,
       bty='n',
       ncol=2,
       pt.lwd=2)

```


















