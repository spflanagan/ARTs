---
title: "Summarizing sensitivity analyses"
author: "Sarah P. Flanagan"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: yes
    number_sections: no
    template: manuscript.latex
    toc: yes
    toc_depth: 2
spacing: singlespacing
fontsize: 11pt
capsize: normalsize
documentclass: article
footerdate: yes
graphics: yes
csl: evolution.csl
editor_options:
  chunk_output_type: console
---


# Overview

The purpose of this model is to understand how genetic architectures of alternative reproductive tactics impact their maintenance in populations. I'm using an individual-based simulation model with different selection scenarios, types of alternative tactics, and genetic architectures (genome-wide additive genetic variance, supergenes, expression networks).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,out.extra='',fig.pos="H",dpi=200,fig.height = 7,fig.width = 7)
knitr::opts_knit$set(root.dir='../fixedART-results/') #change

```
```{r opts, echo = FALSE}
library(knitr)
knitr::opts_chunk$set(
  fig.path = "figs/"
)
```
```{r, echo=FALSE,echo=FALSE,message=FALSE}
library(RColorBrewer)
library(scales)
library(sm)
library(kableExtra)
source("~/Dropbox (UC Enterprise)/Research/ARTs/R/002_freq_functions.R")
cols<-c(courter="#33a02c",parent="#1f78b4",cpref="#b2df8a",ppref="#a6cee3")
cols2<-c(CP='#a1dab4',NCP='#41b6c4',CNP='#2c7fb8',NCNP='#253494')
```
```{r baseCols}
base_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                   "FreqNcP","FreqCP","Courter2NonRS","Parent2NonSurvival")
poly_keep_cols<- c("Pop","PopSize","NumMal","NumFem","ParentThresh","ParentFreq","CourterThresh","CourterFreq","FreqNcNp","FreqCNp",
                    "FreqNcP","FreqCP","Polygyny")

```


Here, I'm presenting the initial sensitivity analysis results. I tested the effects of four parameter settings: mating system, the ratio of reproductive allocation between courters and non-courters, the survival of parental male nests, and the survival of non-parental male nests. 

By 'mating system' I refer to whether males are able to mate with multiple females (i.e., be the nesting male for multiple females). The default is monogamy, meaning males can only be the nesting male to one female. 

The ratio of reproductive allocation between courters and non-courters comes into play during the fertilization stage of the model. At this point, females have mated with a male, and her eggs will be preferentially fertilized by her mate but could also be fertilized by non-courting males. Each male has a maximum reproductive success or reproductive allocation that is given by their courtship status ($r_{courter}$ or $r_{non-courter}$) and gets used up by each additional fertilization. This sets a bound on reproductive success for each male. When a female mates, she receives a total of $\Sigma{n_{sperm}}$ from all of the males who attempt to fertilize her eggs (e.g., with one courter and two non-courters, $\Sigma{n_{sperm}}$ = $r_{courter}$ + 2$*$(0.5$*$$r_{non-courter}$)). The ratio of $r_{courter}$ to $r_{non-courter}$ is the parameter set that I varied in these sensitivity analyses.

The final two traits that I tested were the survival of a nest when it was with parental male and the survival of a nest when it was with a non-parental male. I tested these two parameters separately. When the parental nest survival parameter was tested the non-parental nest survival was constant at 0.1. When the non-parental nest survival parameter was tested the parental nest survival was constant at 0.9.

I tested these parameter settings with three genetic architectures and with just a courter trait, just a parent trait, and both traits: 

```{r params}
params<-data.frame(parameter=c("polygyny","relative reproductive allocation (courter:non-courter)", "parental nest survival","non-parental nest survival", "supergene proportion"),
                   default = c("monogamy","8:4 (2)","0.9","0.1","0.1"),
                   tested_settings = c("polygyny","2:8 (0.25), 4:8 (0.5), 4:4 (1), 8:2 (4)","0.5, 0.6, 0.7, 0.8","0.2, 0.3, 0.4, 0.5","0.5,0.25,0.05"))
kable(params, format="latex", booktabs = T, caption="The parameters, their defaults, and their tested settings") %>% 
  kable_styling(latex_options =c("scale_down","HOLD_position"))
```

Here, I present the initial analyses of those parameter combinations. Note that I ran four replicates for each set of random starting conditions (so if there are 16 replicates, that means I ran the model 4 times from each of 4 sets of starting conditions).


# Courter Trait 

When just the courter trait is present, regardless of the parameter settings or genetic architectures, the courting male morph goes to fixation in every run (Table \@ref(tab:courterSummTable)).

```{r courterSumm, eval=FALSE}
crt_unlinked_summ<-summarize_params(base_pattern="^courter_unlinked",cols,
                                    summ_list="CourterFreq",type="courter")
write.csv(crt_unlinked_summ,"crt_unlinked_summ.csv",row.names = FALSE)
crt_linked_summ<-summarize_params(base_pattern="^courter_linked",cols,
                                  summ_list="CourterFreq",type="courter")
write.csv(crt_linked_summ,"crt_linked_summ.csv",row.names = FALSE)
crt_supergene_summ<-summarize_params(base_pattern="^courter_supergene",cols,
                                     summ_list="CourterFreq",type="courter")
write.csv(crt_supergene_summ,"crt_supergene_summ.csv",row.names = FALSE)
```
```{r courterSummTable}
crt_unlinked_summ<-read.csv("crt_unlinked_summ.csv")
crt_linked_summ<-read.csv("crt_linked_summ.csv")
crt_supergene_summ<-read.csv("crt_supergene_summ.csv")
# Put it all together
crt_summ<-cbind(crt_unlinked_summ,crt_linked_summ[,3:4],crt_supergene_summ[,3:4])
colnames(crt_summ)[3:4]<-paste(colnames(crt_summ)[3:4]," Unlinked",sep="")
colnames(crt_summ)[5:6]<-paste(colnames(crt_summ)[5:6]," Linked",sep="")
colnames(crt_summ)[7:8]<-paste(colnames(crt_summ)[7:8]," Supergene",sep="")
rownames(crt_summ)<-1:nrow(crt_summ)
kable(crt_summ, "latex", booktabs = T, caption = "Summaries of final Courter frequencies",row.names=FALSE) %>% 
  kable_styling(latex_options =c("scale_down","HOLD_position"))
```

When just the courter trait is present, regardless of the parameter settings or genetic architectures, the courting male morph goes to fixation in every run.

### Supergene proportion


```{r supergeneProp}
cs_prop<-plot.courter.reps(pattern="^courter_supergene_prop.*summary.txt.gz",path="sensitivity",cols,make.plot=TRUE)
```


# Parent Trait 


```{r parentSumm, eval=FALSE}
prt_unlinked_summ<-summarize_params(base_pattern="^parent_unlinked",cols,
                                    summ_list="ParentFreq",type="parent")
write.csv(prt_unlinked_summ,"prt_unlinked_summ.csv",row.names = FALSE)
prt_linked_summ<-summarize_params(base_pattern="^parent_linked",cols,
                                  summ_list="ParentFreq",type="parent")
write.csv(prt_linked_summ,"prt_linked_summ.csv",row.names = FALSE)
prt_supergene_summ<-summarize_params(base_pattern="^parent_supergene",cols,
                                     summ_list="ParentFreq",type="parent")
write.csv(prt_supergene_summ,"prt_supergene_summ.csv",row.names = FALSE)
```
```{r parentSummTable}
prt_unlinked_summ<-read.csv("prt_unlinked_summ.csv")
prt_linked_summ<-read.csv("prt_linked_summ.csv")
prt_supergene_summ<-read.csv("prt_supergene_summ.csv")
# Put it all together
prt_summ<-cbind(prt_unlinked_summ,prt_linked_summ[,3:4],prt_supergene_summ[,3:4])
colnames(prt_summ)[3:4]<-paste(colnames(prt_summ)[3:4]," Unlinked",sep="")
colnames(prt_summ)[5:6]<-paste(colnames(prt_summ)[5:6]," Linked",sep="")
colnames(prt_summ)[7:8]<-paste(colnames(prt_summ)[7:8]," Supergene",sep="")
rownames(prt_summ)<-NULL
kable(prt_summ, "latex", booktabs = T, row.names = FALSE,caption = "Summaries of final Parent frequencies") %>% 
  kable_styling(latex_options =c("scale_down","HOLD_position"))
```

When just the parent trait is present, regardless of the parameter settings or genetic architectures, the parental male morph goes to fixation in every run.

# Courter and Parent Traits

## Reproductive Investment Trade-offs

I tested the effect of the ratio of reproductive allocation between courters and non-courters. The ratio of reproductive allocation between courters and non-courters comes into play during the fertilization stage of the model. At this point, females have mated with a male, and her eggs will be preferentially fertilized by her mate but could also be fertilized by non-courting males. Each male has a maximum reproductive success or reproductive allocation that is given by their courtship status ($r_{courter}$ or $r_{non-courter}$) and gets used up by each additional fertilization. This sets a bound on reproductive success for each male. When a female mates, she receives a total of $\Sigma{n_{sperm}}$ from all of the males who attempt to fertilize her eggs (e.g., with one courter and two non-courters, $\Sigma{n_{sperm}}$ = $r_{courter}$ + 2$*$(0.5$*$$r_{non-courter}$)). The ratio of $r_{courter}$ to $r_{non-courter}$ is the parameter set that I varied in these sensitivity analyses.


### Unlinked QTLs



```{r readBaselineUnlinked}
cpu_baseline_freqs<-get.morph.freqs(plot.pc.reps("^parent-courter_unlinked_.*_summary.txt",path="baseline",cols,make.plot=FALSE))
cpu_baseline_freqs$Courter2NonRS<-8/4
cpu_baseline_freqs$Parent2NonSurvival<-0.9/0.1
```

```{r readReproductivAllocationsUnlinked}
cpu_rs_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_unlinked_crs.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cpu_rs_freqs$Courter2NonRS<-as.numeric(
  gsub(".*crs(\\d)_ncrs\\d.*","\\1",rownames(cpu_rs_freqs)))/
    as.numeric(gsub(".*crs\\d_ncrs(\\d).*","\\1",rownames(cpu_rs_freqs)))
cpu_rs_freqs$Parent2NonSurvival<-0.9/0.1
#merge with baseline
cpu_all_freqs<-rbind(cpu_rs_freqs[,base_keep_cols],cpu_baseline_freqs[,base_keep_cols])
```

```{r readParentalSurvivalUnlinked}
cpu_psurv_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_unlinked_psurv.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cpu_psurv_freqs$Parent2NonSurvival<-as.numeric(gsub(".*psurv(\\d.\\d).*","\\1",rownames(cpu_psurv_freqs)))/0.1
cpu_psurv_freqs$Courter2NonRS<-8/4
cpu_all_freqs<-rbind(cpu_psurv_freqs[,base_keep_cols],cpu_all_freqs)
```

```{r readNonParentalSurvivalUnlinked}
cpu_npsurv_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_unlinked_npsurv.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cpu_npsurv_freqs$Parent2NonSurvival<-0.9/as.numeric(gsub(".*psurv(\\d.\\d).*","\\1",rownames(cpu_npsurv_freqs)))
cpu_npsurv_freqs$Courter2NonRS<-8/4
cpu_all_freqs<-rbind(cpu_npsurv_freqs[,base_keep_cols],cpu_all_freqs)
```

```{r readNonParentalRAUnlinked}
cpu_ra_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_unlinked_RA_.*_summary.txt",path="repro_allocation",cols,make.plot=FALSE))
cpu_ra_freqs$Parent2NonSurvival<-as.numeric(gsub(".*_p(\\d.\\d).*","\\1",rownames(cpu_ra_freqs)))/as.numeric(gsub(".*np(\\d.\\d).*","\\1",rownames(cpu_ra_freqs)))
cpu_ra_freqs$Courter2NonRS<-as.numeric(gsub(".*_c(\\d).*","\\1",rownames(cpu_ra_freqs)))/as.numeric(gsub(".*nc(\\d).*","\\1",rownames(cpu_ra_freqs)))
cpu_all_freqs<-rbind(cpu_ra_freqs[,base_keep_cols],cpu_all_freqs)
```



```{r plotRAunlinkedSumm}
plot_2vars_summary(cpu_all_freqs,"Courter2NonRS","Parent2NonSurvival",mar=c(5.1,4.1,4.1,2.1))
```

### Linked QTLs


```{r readBaselineLinked}
cpl_baseline_freqs<-get.morph.freqs(plot.pc.reps("^parent-courter_linked_.*_summary.txt",path="baseline",cols,make.plot=FALSE))
cpl_baseline_freqs$Courter2NonRS<-8/4
cpl_baseline_freqs$Parent2NonSurvival<-0.9/0.1
```

```{r readReproductivAllocationsLinked}
cpl_rs_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_linked_crs.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cpl_rs_freqs$Courter2NonRS<-as.numeric(
  gsub(".*crs(\\d)_ncrs\\d.*","\\1",rownames(cpl_rs_freqs)))/
    as.numeric(gsub(".*crs\\d_ncrs(\\d).*","\\1",rownames(cpl_rs_freqs)))
cpl_rs_freqs$Parent2NonSurvival<-0.9/0.1
#merge with baseline
cpl_all_freqs<-rbind(cpl_rs_freqs[,base_keep_cols],cpl_baseline_freqs[,base_keep_cols])
```

```{r readParentalSurvivalLinked}
cpl_psurv_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_linked_psurv.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cpl_psurv_freqs$Parent2NonSurvival<-as.numeric(gsub(".*psurv(\\d.\\d).*","\\1",rownames(cpl_psurv_freqs)))/0.1
cpl_psurv_freqs$Courter2NonRS<-8/4
cpl_all_freqs<-rbind(cpl_psurv_freqs[,base_keep_cols],cpl_all_freqs)
```

```{r readNonParentalSurvivalLinked}
cpl_npsurv_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_linked_npsurv.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cpl_npsurv_freqs$Parent2NonSurvival<-0.9/as.numeric(gsub(".*psurv(\\d.\\d).*","\\1",rownames(cpl_npsurv_freqs)))
cpl_npsurv_freqs$Courter2NonRS<-8/4
cpl_all_freqs<-rbind(cpl_npsurv_freqs[,base_keep_cols],cpl_all_freqs)
```

```{r readNonParentalRALinked}
cpl_ra_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_linked_RA_.*_summary.txt",path="repro_allocation",cols,make.plot=FALSE))
cpl_ra_freqs$Parent2NonSurvival<-as.numeric(gsub(".*_p(\\d.\\d).*","\\1",rownames(cpl_ra_freqs)))/as.numeric(gsub(".*np(\\d.\\d).*","\\1",rownames(cpl_ra_freqs)))
cpl_ra_freqs$Courter2NonRS<-as.numeric(gsub(".*_c(\\d).*","\\1",rownames(cpl_ra_freqs)))/as.numeric(gsub(".*nc(\\d).*","\\1",rownames(cpl_ra_freqs)))
cpl_all_freqs<-rbind(cpl_ra_freqs[,base_keep_cols],cpl_all_freqs)
```


```{r plotRAlinkedSumm}
plot_2vars_summary(cpl_all_freqs,"Courter2NonRS","Parent2NonSurvival",mar=c(5.1,4.1,4.1,2.1))
```

### QTLs in a supergene


```{r readBaselineSupergene}
cps_baseline_freqs<-get.morph.freqs(plot.pc.reps("^parent-courter_supergene_.*_summary.txt",path="baseline",cols,make.plot=FALSE))
cps_baseline_freqs$Courter2NonRS<-8/4
cps_baseline_freqs$Parent2NonSurvival<-0.9/0.1
```

```{r readReproductivAllocationsSupergene}
cps_rs_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_supergene_crs.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cps_rs_freqs$Courter2NonRS<-as.numeric(
  gsub(".*crs(\\d)_ncrs\\d.*","\\1",rownames(cps_rs_freqs)))/
    as.numeric(gsub(".*crs\\d_ncrs(\\d).*","\\1",rownames(cps_rs_freqs)))
cps_rs_freqs$Parent2NonSurvival<-0.9/0.1
#merge with baseline
cps_all_freqs<-rbind(cps_rs_freqs[,base_keep_cols],cps_baseline_freqs[,base_keep_cols])
```

```{r readParentalSurvivalSupergene}
cps_psurv_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_supergene_psurv.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cps_psurv_freqs$Parent2NonSurvival<-as.numeric(gsub(".*psurv(\\d.\\d).*","\\1",rownames(cps_psurv_freqs)))/0.1
cps_psurv_freqs$Courter2NonRS<-8/4
cps_all_freqs<-rbind(cps_psurv_freqs[,base_keep_cols],cps_all_freqs)
```

```{r readNonParentalSurvivalSupergene}
cps_npsurv_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_supergene_npsurv.*_summary.txt",path="sensitivity",cols,make.plot=FALSE))
cps_npsurv_freqs$Parent2NonSurvival<-0.9/as.numeric(gsub(".*psurv(\\d.\\d).*","\\1",rownames(cps_npsurv_freqs)))
cps_npsurv_freqs$Courter2NonRS<-8/4
cps_all_freqs<-rbind(cps_npsurv_freqs[,base_keep_cols],cps_all_freqs)
```

```{r readNonParentalRASupergene}
cps_ra_freqs<-get.morph.freqs(plot.pc.reps(pattern="^parent-courter_supergene_RA_.*_summary.txt",path="repro_allocation",cols,make.plot=FALSE))
cps_ra_freqs$Parent2NonSurvival<-as.numeric(gsub(".*_p(\\d.\\d).*","\\1",rownames(cps_ra_freqs)))/as.numeric(gsub(".*np(\\d.\\d).*","\\1",rownames(cps_ra_freqs)))
cps_ra_freqs$Courter2NonRS<-as.numeric(gsub(".*_c(\\d).*","\\1",rownames(cps_ra_freqs)))/as.numeric(gsub(".*nc(\\d).*","\\1",rownames(cps_ra_freqs)))
cps_all_freqs<-rbind(cps_ra_freqs[,base_keep_cols],cps_all_freqs)
```


```{r plotRAsupergeneSumm}
plot_2vars_summary(cps_all_freqs,"Courter2NonRS","Parent2NonSurvival")
```



## Mating System

By 'mating system' I refer to whether males are able to mate with multiple females (i.e., be the nesting male for multiple females). The default is monogamy, meaning males can only be the nesting male to one female. 

### Unlinked

```{r UnlinkedPolygyny}
cpu_polygyny<-plot.pc.reps(pattern="^parent-courter_unlinked_polygyny_.*_summary.txt",path="sensitivity",cols,make.plot=FALSE)
cpu_polygyny_freqs<-get.morph.freqs(cpu_polygyny)
cpu_polygyny_freqs$Polygyny<-TRUE
#merge with baseline
cpu_baseline_freqs$Polygyny<-FALSE
cpu_ms_freqs<-rbind(cpu_polygyny_freqs[,base_keep_cols],cpu_baseline_freqs[,base_keep_cols])
cpu_ms_freqs$MSnum<-as.numeric(cpu_ms_freqs$Polygyny)
```

```{r UnlinkedPolygynyParentThresh}
plot_2vars_summary(cpu_ms_freqs,"ParentThresh","MSnum",xlab="Parent Threshold Value",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```
```{r UnlinkedPolygynyCourterThresh}
plot_2vars_summary(cpu_ms_freqs,"CourterThresh","MSnum",xlab="Courter Threshold Value",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```
```{r UnlinkedPolygynyThreshDiff}
cpu_ms_freqs$CourtParentThresh<-cpu_ms_freqs$CourterThresh-cpu_ms_freqs$ParentThresh
plot_2vars_summary(cpu_ms_freqs,"CourtParentThresh","MSnum",xlab="Difference in thresholds (courter-parent)",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```


### Linked

```{r LinkedPolygyny}
cpl_polygyny<-plot.pc.reps(pattern="^parent-courter_linked_polygyny_.*_summary.txt",path="sensitivity",cols,make.plot=FALSE)
cpl_polygyny_freqs<-get.morph.freqs(cpl_polygyny)
cpl_polygyny_freqs$Polygyny<-TRUE
#merge with baseline
cpl_baseline_freqs$Polygyny<-FALSE
cpl_ms_freqs<-rbind(cpl_polygyny_freqs[,base_keep_cols],cpl_baseline_freqs[,base_keep_cols])
cpl_ms_freqs$MSnum<-as.numeric(cpl_ms_freqs$Polygyny)
```

```{r LinkedPolygynyParentThresh}
plot_2vars_summary(cpl_ms_freqs,"ParentThresh","MSnum",xlab="Parent Threshold Value",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```
```{r LinkedPolygynyCourterThresh}
plot_2vars_summary(cpl_ms_freqs,"CourterThresh","MSnum",xlab="Courter Threshold Value",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```
```{r LinkedPolygynyThreshDiff}
cpl_ms_freqs$CourtParentThresh<-cpl_ms_freqs$CourterThresh-cpl_ms_freqs$ParentThresh
plot_2vars_summary(cpl_ms_freqs,"CourtParentThresh","MSnum",xlab="Difference in thresholds (courter-parent)",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```

### Supergene

```{r SupergenePolygyny}
cps_polygyny<-plot.pc.reps(pattern="^parent-courter_supergene_polygyny_.*_summary.txt",path="sensitivity",cols,make.plot=FALSE)
cps_polygyny_freqs<-get.morph.freqs(cps_polygyny)
cps_polygyny_freqs$Polygyny<-TRUE
#merge with baseline
cps_baseline_freqs$Polygyny<-FALSE
cps_ms_freqs<-rbind(cps_polygyny_freqs[,base_keep_cols],cps_baseline_freqs[,base_keep_cols])
cps_ms_freqs$MSnum<-as.numeric(cps_ms_freqs$Polygyny)
```

```{r SupergenePolygynyParentThresh}
plot_2vars_summary(cpu_ms_freqs,"ParentThresh","MSnum",xlab="Parent Threshold Value",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```
```{r SupergenePolygynyCourterThresh}
plot_2vars_summary(cpu_ms_freqs,"CourterThresh","MSnum",xlab="Courter Threshold Value",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```
```{r SupergenePolygynyThreshDiff}
cpu_ms_freqs$CourtParentThresh<-cpu_ms_freqs$CourterThresh-cpu_ms_freqs$ParentThresh
plot_2vars_summary(cpu_ms_freqs,"CourtParentThresh","MSnum",xlab="Difference in thresholds (courter-parent)",ylab="Polygyny",mar=c(5.1,4.1,4.1,2.1))
```

